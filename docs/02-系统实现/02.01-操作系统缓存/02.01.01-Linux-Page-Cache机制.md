# 02.01.01 Linux Page Cache机制

## 概述

Linux Page Cache是操作系统层面的缓存机制，将磁盘文件内容缓存在内存中，大幅提升文件I/O性能。理解Page Cache机制对于优化Redis持久化和系统性能至关重要。

## Page Cache原理

### 基本概念

```c
// Page Cache基本概念
// 1. 将文件内容缓存在内存页中
// 2. 读写操作首先访问Page Cache
// 3. 缓存未命中时才访问磁盘

struct page {
    unsigned long flags;        // 页面标志
    struct address_space *mapping;  // 地址空间
    void *virtual;              // 虚拟地址
    // ...
};
```

### 工作流程

```
读操作：
1. 检查Page Cache
2. 命中：直接返回
3. 未命中：从磁盘读取，写入Page Cache，返回

写操作：
1. 写入Page Cache（Write-Back）
2. 标记页面为dirty
3. 后台刷新到磁盘（pdflush/kthread）
```

## Page Cache管理

### 1. 页面分配

```c
// 页面分配
struct page *page_cache_alloc(struct address_space *mapping) {
    return alloc_pages(mapping_gfp_mask(mapping), 0);
}

// 添加到Page Cache
void add_to_page_cache(struct page *page,
                      struct address_space *mapping,
                      pgoff_t offset) {
    // 添加到radix tree
    radix_tree_insert(&mapping->page_tree, offset, page);
    // 更新统计
    mapping->nrpages++;
}
```

### 2. 页面查找

```c
// 查找页面
struct page *find_get_page(struct address_space *mapping,
                          pgoff_t offset) {
    struct page *page;

    // 从radix tree查找
    page = radix_tree_lookup(&mapping->page_tree, offset);
    if (page) {
        // 增加引用计数
        page_cache_get(page);
    }

    return page;
}
```

### 3. 页面回收

```c
// 页面回收（LRU算法）
void shrink_page_list(struct list_head *page_list,
                     struct scan_control *sc) {
    struct page *page;

    list_for_each_entry(page, page_list, lru) {
        // 检查是否可以回收
        if (PageDirty(page)) {
            // 脏页：先写回
            writeback_page(page);
        } else {
            // 干净页：直接回收
            free_page(page);
        }
    }
}
```

## 性能特征

### 1. 命中率

```python
# Page Cache命中率
class PageCacheHitRate:
    def calculate(self, cache_hits, total_requests):
        """计算命中率"""
        return (cache_hits / total_requests) * 100 if total_requests > 0 else 0

    def analyze(self):
        """分析命中率"""
        return {
            'good': '>80%',
            'normal': '50-80%',
            'poor': '<50%',
        }
```

### 2. 延迟

```python
# Page Cache延迟
class PageCacheLatency:
    def compare(self):
        """延迟对比"""
        return {
            'cache_hit': '0.1-1μs',      # 缓存命中
            'cache_miss': '5-15ms',      # 缓存未命中（磁盘读取）
            'improvement': '1000-15000x', # 性能提升
        }
```

## Redis中的应用

### 1. RDB文件缓存

```python
# RDB文件在Page Cache中
class RDBPageCache:
    def analyze(self):
        """分析RDB文件缓存"""
        return {
            'benefit': 'RDB文件缓存在Page Cache中，读取速度快',
            'optimization': '使用mmap映射RDB文件到Page Cache',
        }
```

### 2. AOF文件缓存

```python
# AOF文件在Page Cache中
class AOFPageCache:
    def analyze(self):
        """分析AOF文件缓存"""
        return {
            'benefit': 'AOF追加写入受益于Page Cache',
            'optimization': '使用O_DIRECT绕过Page Cache（可选）',
        }
```

## 优化策略

### 1. 预读优化

```bash
# 预读优化
# 调整预读大小
echo 16384 > /sys/block/sda/queue/read_ahead_kb

# 禁用预读（某些场景）
echo 0 > /sys/block/sda/queue/read_ahead_kb
```

### 2. 脏页刷新

```bash
# 脏页刷新参数
# /proc/sys/vm/dirty_ratio: 系统脏页比例阈值（默认20%）
# /proc/sys/vm/dirty_background_ratio: 后台刷新阈值（默认10%）
# /proc/sys/vm/dirty_expire_centisecs: 脏页过期时间（默认3000）

# 优化配置
echo 10 > /proc/sys/vm/dirty_ratio
echo 5 > /proc/sys/vm/dirty_background_ratio
```

### 3. 内存回收

```bash
# 内存回收参数
# /proc/sys/vm/swappiness: 交换倾向（0-100）
# 0：优先回收Page Cache
# 100：优先交换

# 优化配置（Redis场景）
echo 1 > /proc/sys/vm/swappiness  # 优先回收Page Cache
```

## 监控工具

### 1. free命令

```bash
# 查看Page Cache使用情况
free -h

# 输出示例：
#               total        used        free      shared  buff/cache   available
# Mem:           16Gi        2Gi        8Gi       100Mi        6Gi        13Gi
# buff/cache: Page Cache + Buffer Cache
```

### 2. /proc/meminfo

```bash
# 查看详细内存信息
cat /proc/meminfo | grep -E "Cached|Buffers|Dirty"

# 关键指标：
# Cached: Page Cache大小
# Buffers: Buffer Cache大小
# Dirty: 脏页大小
```

### 3. sar命令

```bash
# 监控Page Cache命中率
sar -B 1

# 输出示例：
# 00:00:01  pgpgin/s pgpgout/s fault/s majflt/s pgfree/s pgscank/s pgscand/s pgsteal/s
# 00:00:02      0.00      0.00   10.00      0.00   20.00      0.00      0.00      0.00
```

## 扩展阅读

- [SSD持久化性能](../05-全栈分析/05.01-硬件层深度剖析/05.01.03-SSD持久化性能.md)
- [RDB快照机制](../03-Redis组件/03.02-持久化机制/03.02.01-RDB快照机制.md)
- [AOF日志机制](../03-Redis组件/03.02-持久化机制/03.02.02-AOF日志机制.md)

## 权威参考

- **《Linux内核设计与实现》** - Robert Love
- **《深入理解Linux内核》** - Daniel P. Bovet
- **Linux内核文档** - <https://www.kernel.org/doc/Documentation/>
