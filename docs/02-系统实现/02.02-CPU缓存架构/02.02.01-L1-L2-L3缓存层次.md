# 02.02.01 L1/L2/L3缓存层次

## 概述

CPU缓存是计算机系统中速度最快的内存层次，通过多级缓存（L1、L2、L3）减少内存访问延迟，提升系统性能。理解CPU缓存层次对于优化Redis性能至关重要。

## 缓存层次结构

### 层次架构

```
CPU核心
  ↓
L1缓存（最快，最小）
  ↓
L2缓存（较快，中等）
  ↓
L3缓存（较慢，较大）
  ↓
主内存（最慢，最大）
```

### 性能特征

```python
# CPU缓存性能特征
class CPUCacheHierarchy:
    def __init__(self):
        self.characteristics = {
            'L1': {
                'size': '32-64KB',
                'latency': '1-3 cycles',
                'bandwidth': '~1000 GB/s',
                'location': '每个核心',
            },
            'L2': {
                'size': '256KB-1MB',
                'latency': '10-20 cycles',
                'bandwidth': '~500 GB/s',
                'location': '每个核心',
            },
            'L3': {
                'size': '8-32MB',
                'latency': '40-75 cycles',
                'bandwidth': '~200 GB/s',
                'location': '共享（所有核心）',
            },
            '主内存': {
                'size': 'GB级别',
                'latency': '100-300 cycles',
                'bandwidth': '~50 GB/s',
                'location': '系统级',
            },
        }
```

## L1缓存

### 结构

```c
// L1缓存结构
// 通常分为L1I（指令缓存）和L1D（数据缓存）

struct l1_cache {
    int size;           // 32-64KB
    int associativity;  // 8-way
    int line_size;     // 64 bytes
    int latency;        // 1-3 cycles
};
```

### 特点

- **速度最快**：1-3个CPU周期
- **容量最小**：32-64KB
- **每个核心独立**：L1I和L1D分离

## L2缓存

### 结构

```c
// L2缓存结构
struct l2_cache {
    int size;           // 256KB-1MB
    int associativity;  // 16-way
    int line_size;     // 64 bytes
    int latency;        // 10-20 cycles
};
```

### 特点

- **速度较快**：10-20个CPU周期
- **容量中等**：256KB-1MB
- **每个核心独立**：统一缓存（指令+数据）

## L3缓存

### 结构

```c
// L3缓存结构
struct l3_cache {
    int size;           // 8-32MB
    int associativity;  // 16-32-way
    int line_size;     // 64 bytes
    int latency;        // 40-75 cycles
};
```

### 特点

- **速度较慢**：40-75个CPU周期
- **容量较大**：8-32MB
- **所有核心共享**：减少缓存一致性开销

## 缓存缺失

### 缺失类型

```python
# 缓存缺失类型
class CacheMiss:
    def __init__(self):
        self.miss_types = {
            'compulsory': {
                'description': '强制缺失（首次访问）',
                'solution': '预取',
            },
            'capacity': {
                'description': '容量缺失（缓存太小）',
                'solution': '增大缓存',
            },
            'conflict': {
                'description': '冲突缺失（映射冲突）',
                'solution': '提高关联度',
            },
        }
```

### 缺失代价

```python
# 缓存缺失代价
class CacheMissCost:
    def calculate(self, cache_level):
        """计算缺失代价"""
        costs = {
            'L1_miss': 10,   # cycles
            'L2_miss': 40,   # cycles
            'L3_miss': 100,  # cycles
            'memory': 300,   # cycles
        }
        return costs.get(cache_level, 0)
```

## Redis优化

### 1. 数据结构对齐

```c
// 数据结构对齐到缓存行（64字节）
struct aligned_struct {
    int data[16];  // 64字节，对齐到缓存行
} __attribute__((aligned(64)));
```

### 2. 预取优化

```c
// 预取数据到缓存
void prefetch_data(void *addr) {
    __builtin_prefetch(addr, 0, 3);  // 预取到L1
}
```

### 3. 减少缓存缺失

```c
// 减少缓存缺失的策略
// 1. 数据结构紧凑
// 2. 访问模式局部性
// 3. 预取数据
```

## 性能测试

### 1. 缓存延迟测试

```c
// 缓存延迟测试
void measure_cache_latency(void) {
    volatile char *array = malloc(64 * 1024 * 1024);
    int i, j;
    clock_t start, end;

    // L1测试（32KB）
    start = clock();
    for (i = 0; i < 1000000; i++) {
        array[(i * 64) % (32 * 1024)]++;
    }
    end = clock();
    printf("L1 latency: %ld cycles\n", end - start);

    // L2测试（256KB）
    start = clock();
    for (i = 0; i < 1000000; i++) {
        array[(i * 64) % (256 * 1024)]++;
    }
    end = clock();
    printf("L2 latency: %ld cycles\n", end - start);
}
```

### 2. 缓存命中率测试

```bash
# 使用perf工具测试缓存命中率
perf stat -e cache-references,cache-misses ./redis-benchmark

# 输出示例：
#  cache-references: 1000000
#  cache-misses: 100000
#  命中率: 90%
```

## 扩展阅读

- [CPU缓存与伪共享](../05-全栈分析/05.01-硬件层深度剖析/05.01.01-CPU缓存与伪共享.md)
- [NUMA架构影响](../05-全栈分析/05.01-硬件层深度剖析/05.01.02-NUMA架构影响.md)
- [内存带宽分析](../05-全栈分析/05.01-硬件层深度剖析/05.01.04-内存带宽分析.md)

## 权威参考

- **《深入理解计算机系统》** - CMU
- **《计算机体系结构：量化研究方法》** - Hennessy & Patterson
- **Intel架构文档** - <https://www.intel.com/content/www/us/en/developer/articles/technical/>
