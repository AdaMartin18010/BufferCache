# 02.05.01 NUMA架构优化

## 概述

NUMA（Non-Uniform Memory Access）是非统一内存访问架构，多核系统中不同核心访问不同内存节点的延迟不同。理解NUMA架构对于优化Redis多实例部署至关重要。

## NUMA架构原理

### 基本概念

```c
// NUMA架构基本概念
// 1. 每个NUMA节点有本地内存
// 2. 访问本地内存快，访问远程内存慢
// 3. 需要优化内存分配策略

struct numa_node {
    int node_id;           // 节点ID
    void *local_memory;    // 本地内存
    size_t memory_size;    // 内存大小
    int cpu_count;         // CPU核心数
};
```

### 访问延迟

```python
# NUMA访问延迟
class NUMALatency:
    def __init__(self):
        self.latencies = {
            'local': '100ns',      # 本地内存访问
            'remote': '200-300ns', # 远程内存访问
            'ratio': '2-3x',       # 延迟比例
        }
```

## Redis优化

### 1. NUMA绑定

```bash
# 绑定Redis进程到特定NUMA节点
numactl --cpunodebind=0 --membind=0 redis-server

# 查看NUMA拓扑
numactl --hardware

# 输出示例：
# available: 2 nodes (0-1)
# node 0 cpus: 0 1 2 3
# node 0 size: 16384 MB
# node 1 cpus: 4 5 6 7
# node 1 size: 16384 MB
```

### 2. 内存分配策略

```bash
# 设置内存分配策略
# 0: 默认（可能分配到远程内存）
# 1: 本地优先
# 2: 绑定到特定节点
# 4: 交错分配

# 本地优先
echo 1 > /proc/sys/kernel/numa_balancing

# 绑定到节点0
numactl --membind=0 redis-server
```

### 3. 多实例部署

```bash
# 多实例NUMA优化
# 实例1：绑定到节点0
numactl --cpunodebind=0 --membind=0 redis-server --port 6379

# 实例2：绑定到节点1
numactl --cpunodebind=1 --membind=1 redis-server --port 6380
```

## 性能测试

### 1. 延迟测试

```c
// NUMA延迟测试
void test_numa_latency(void) {
    void *local_mem = numa_alloc_onnode(1024 * 1024, 0);
    void *remote_mem = numa_alloc_onnode(1024 * 1024, 1);

    // 测试本地内存访问
    clock_t start = clock();
    for (int i = 0; i < 1000000; i++) {
        ((int *)local_mem)[i % 256] = i;
    }
    clock_t local_time = clock() - start;

    // 测试远程内存访问
    start = clock();
    for (int i = 0; i < 1000000; i++) {
        ((int *)remote_mem)[i % 256] = i;
    }
    clock_t remote_time = clock() - start;

    printf("Local: %ld, Remote: %ld, Ratio: %.2f\n",
           local_time, remote_time, (float)remote_time / local_time);
}
```

### 2. 带宽测试

```bash
# 使用numactl测试NUMA带宽
numactl --membind=0 --cpunodebind=0 redis-benchmark
numactl --membind=1 --cpunodebind=0 redis-benchmark  # 远程访问
```

## 配置优化

### 1. Redis配置

```conf
# redis.conf
# NUMA优化配置

# 禁用透明大页（NUMA场景）
disable-thp yes

# 内存分配器（使用jemalloc，支持NUMA）
# 编译时指定jemalloc
```

### 2. 系统配置

```bash
# 禁用NUMA平衡（某些场景）
echo 0 > /proc/sys/kernel/numa_balancing

# 设置内存分配策略
echo 1 > /proc/sys/kernel/numa_balancing
```

## 扩展阅读

- [NUMA架构影响](../05-全栈分析/05.01-硬件层深度剖析/05.01.02-NUMA架构影响.md)
- [内存带宽分析](../05-全栈分析/05.01-硬件层深度剖析/05.01.04-内存带宽分析.md)
- [L1/L2/L3缓存层次](./02.02.01-L1-L2-L3缓存层次.md)

## 权威参考

- **《深入理解计算机系统》** - CMU
- **Intel NUMA文档** - <https://www.intel.com/content/www/us/en/developer/articles/technical/>
- **Linux NUMA文档** - <https://www.kernel.org/doc/Documentation/vm/numa_memory_policy.txt>
