# 02.05.02 HugePages大页内存

## 概述

HugePages（大页内存）是Linux内核提供的内存管理优化技术，使用更大的内存页（通常2MB或1GB）减少页表项数量，提升内存访问性能。理解HugePages对于优化Redis内存性能至关重要。

## HugePages原理

### 基本概念

```c
// HugePages基本概念
// 1. 标准页大小：4KB
// 2. 大页大小：2MB或1GB
// 3. 减少页表项数量，提升TLB命中率

// 页表项数量对比
// 标准页（4KB）：1GB内存需要262144个页表项
// 大页（2MB）：1GB内存需要512个页表项
// 大页（1GB）：1GB内存需要1个页表项
```

### 性能优势

```python
# HugePages性能优势
class HugePagesAdvantage:
    def __init__(self):
        self.advantages = {
            'tlb_hit_rate': {
                'standard': '90%',
                'hugepages': '99%',
                'improvement': '+9%',
            },
            'page_table_size': {
                'standard': '2MB (1GB内存)',
                'hugepages_2mb': '4KB (1GB内存)',
                'hugepages_1gb': '8 bytes (1GB内存)',
                'reduction': '99.8%',
            },
            'memory_overhead': {
                'standard': '0.2%',
                'hugepages': '0.01%',
                'reduction': '95%',
            },
        }
```

## 配置HugePages

### 1. 查看系统支持

```bash
# 查看HugePages支持
cat /proc/meminfo | grep -i huge

# 输出示例：
# AnonHugePages:      2048 kB
# ShmemHugePages:        0 kB
# HugePages_Total:       0
# HugePages_Free:        0
# HugePages_Rsvd:        0
# HugePages_Surp:        0
# Hugepagesize:       2048 kB
```

### 2. 配置HugePages数量

```bash
# 计算需要的HugePages数量
# Redis内存：8GB
# HugePages大小：2MB
# 需要的HugePages：8GB / 2MB = 4096

# 设置HugePages数量
echo 4096 > /proc/sys/vm/nr_hugepages

# 永久设置（/etc/sysctl.conf）
echo "vm.nr_hugepages = 4096" >> /etc/sysctl.conf
sysctl -p
```

### 3. 挂载HugePages文件系统

```bash
# 挂载HugePages文件系统
mkdir -p /mnt/hugepages
mount -t hugetlbfs nodev /mnt/hugepages

# 永久挂载（/etc/fstab）
echo "nodev /mnt/hugepages hugetlbfs defaults 0 0" >> /etc/fstab
```

## Redis配置

### 1. 启用HugePages

```conf
# redis.conf
# 启用透明大页（THP）
# 注意：Redis推荐禁用THP，使用传统HugePages

# 禁用透明大页
disable-thp yes
```

### 2. 使用HugePages

```bash
# 方法1：使用mmap映射HugePages
# Redis会自动使用HugePages（如果可用）

# 方法2：使用HugePages文件系统
# 需要修改Redis源码，使用HugePages文件系统
```

### 3. 验证HugePages使用

```bash
# 查看Redis进程的HugePages使用
cat /proc/$(pgrep redis-server)/smaps | grep -i huge

# 查看系统HugePages使用
cat /proc/meminfo | grep -i huge
```

## 性能测试

### 1. TLB命中率测试

```c
// TLB命中率测试
void test_tlb_hit_rate(void) {
    // 标准页测试
    void *standard_mem = malloc(1024 * 1024 * 1024);  // 1GB
    clock_t start = clock();
    for (int i = 0; i < 1000000; i++) {
        ((int *)standard_mem)[i % (1024 * 1024 * 1024 / 4)] = i;
    }
    clock_t standard_time = clock() - start;

    // 大页测试（需要特殊分配）
    // ...

    printf("Standard: %ld, HugePages: %ld, Improvement: %.2f%%\n",
           standard_time, hugepages_time,
           (float)(standard_time - hugepages_time) / standard_time * 100);
}
```

### 2. 内存访问延迟测试

```bash
# 使用perf工具测试TLB缺失
perf stat -e dTLB-loads,dTLB-load-misses ./redis-benchmark

# 计算TLB命中率
# 命中率 = (1 - dTLB-load-misses / dTLB-loads) * 100
```

## 优化建议

### 1. 内存大小选择

```python
# HugePages大小选择
class HugePagesSizeSelection:
    def recommend(self, memory_size):
        """推荐HugePages大小"""
        if memory_size < 1 * 1024:  # < 1GB
            return '2MB'  # 使用2MB大页
        elif memory_size < 64 * 1024:  # < 64GB
            return '2MB'  # 使用2MB大页
        else:  # >= 64GB
            return '1GB'  # 使用1GB大页
```

### 2. 数量配置

```bash
# 配置HugePages数量
# 1. 计算Redis内存需求
# 2. 添加20%余量
# 3. 除以HugePages大小

# 示例：Redis 8GB内存，2MB大页
# (8GB + 20%) / 2MB = 4915
echo 4915 > /proc/sys/vm/nr_hugepages
```

### 3. 透明大页（THP）

```bash
# 禁用透明大页（Redis推荐）
# THP可能导致延迟抖动

# 检查THP状态
cat /sys/kernel/mm/transparent_hugepage/enabled

# 禁用THP
echo never > /sys/kernel/mm/transparent_hugepage/enabled
echo never > /sys/kernel/mm/transparent_hugepage/defrag

# 永久禁用（/etc/rc.local）
echo 'echo never > /sys/kernel/mm/transparent_hugepage/enabled' >> /etc/rc.local
echo 'echo never > /sys/kernel/mm/transparent_hugepage/defrag' >> /etc/rc.local
```

## 注意事项

### 1. 内存碎片

```python
# HugePages可能导致内存碎片
# 问题：大页分配失败（内存碎片）
# 解决：
# 1. 系统启动时预留HugePages
# 2. 使用1GB大页（减少碎片）
# 3. 定期检查HugePages可用性
```

### 2. 兼容性

```bash
# 检查应用兼容性
# 某些应用可能不支持HugePages
# Redis支持HugePages（自动使用）
```

### 3. 监控

```bash
# 监控HugePages使用
watch -n 1 'cat /proc/meminfo | grep -i huge'

# 告警：HugePages_Free < 10%
```

## 扩展阅读

- [NUMA架构优化](./02.05.01-NUMA架构优化.md)
- [内存分配与回收](../03-Redis组件/03.04-内存管理/03.04.01-内存分配与回收.md)
- [Linux Page Cache机制](../02.01-操作系统缓存/02.01.01-Linux-Page-Cache机制.md)

## 权威参考

- **《Linux内核设计与实现》** - Robert Love
- **《深入理解Linux内核》** - Daniel P. Bovet
- **Linux内核文档** - <https://www.kernel.org/doc/Documentation/vm/hugetlbpage.txt>
