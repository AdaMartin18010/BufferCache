# 03.02.01 RDB快照机制

## 概述

RDB（Redis Database）是Redis的持久化机制之一，通过创建数据快照的方式将内存中的数据保存到磁盘。

## 核心原理

### 快照机制

RDB通过**fork子进程**的方式创建数据快照，子进程负责将内存数据写入RDB文件，主进程继续处理请求。

### Copy-on-Write（COW）

```c
// fork()创建子进程时，父子进程共享内存页
pid_t pid = fork();

if (pid == 0) {
    // 子进程：遍历数据库，写入RDB文件
    rdbSave("dump.rdb");
    exit(0);
} else {
    // 主进程：继续处理请求
    // 修改数据时触发COW，复制页面
}
```

**COW机制**：
- fork()时：父子进程共享内存页（只读）
- 写入时：触发页错误，复制修改的页面
- 优势：减少内存拷贝，提升性能

## RDB文件格式

### 文件结构

```
+------------------+
| REDIS            | 5字节：魔数
+------------------+
| RDB-VERSION      | 4字节：版本号（如"0006"）
+------------------+
| AUX              | 辅助字段（可选）
+------------------+
| SELECTDB         | 数据库选择
+------------------+
| KEY-VALUE-PAIRS  | 键值对数据
+------------------+
| EOF              | 结束标记
+------------------+
| CHECK-SUM        | 8字节：CRC64校验和
+------------------+
```

### 键值对编码

```c
// 字符串编码
+--------+--------+--------+
| TYPE   | LEN    | DATA   |
+--------+--------+--------+
| 1 byte | varint | N bytes|

// 列表编码
+--------+--------+--------+--------+
| TYPE   | LEN    | ELEM1  | ELEM2  |
+--------+--------+--------+--------+
| 1 byte | varint | ...    | ...    |
```

## 触发机制

### 手动触发

```bash
# SAVE命令：阻塞主线程
127.0.0.1:6379> SAVE
OK

# BGSAVE命令：后台执行
127.0.0.1:6379> BGSAVE
Background saving started by pid 12345
```

### 自动触发

```c
// Redis配置
struct saveparam {
    time_t seconds;   // 时间窗口
    int changes;      // 修改次数阈值
};

// 周期性检查
int serverCron(struct aeEventLoop *eventLoop, long long id, void *clientData) {
    // 检查save条件
    for (j = 0; j < server.saveparamslen; j++) {
        struct saveparam *sp = server.saveparams+j;

        if (server.dirty >= sp->changes &&
            server.unixtime-server.lastsave > sp->seconds)
        {
            // 触发BGSAVE
            rdbSaveBackground(server.rdb_filename);
            break;
        }
    }
}
```

**默认配置**：
```conf
save 900 1      # 900秒内至少1次修改
save 300 10     # 300秒内至少10次修改
save 60 10000   # 60秒内至少10000次修改
```

## 性能分析

### fork()性能

```c
// fork()耗时分析
fork_time = page_table_copy_time + COW_setup_time

// 页表拷贝
page_table_size = memory_size / page_size * 8 bytes
page_table_copy_time = page_table_size / memory_bandwidth

// 示例：16GB内存
page_table_size = 16GB / 4KB * 8 = 32MB
page_table_copy_time = 32MB / 20GB/s ≈ 1.6ms

// 实际观测：50-100ms（包含其他开销）
```

### COW成本

```c
// COW页面复制成本
COW_cost_per_page = page_fault_time + page_copy_time
                   = 100ns + 4KB/20GB/s
                   = 100ns + 200ns
                   = 300ns/page

// BGSAVE期间10万次写入
total_COW_cost = 100000 * 300ns = 30ms
```

### 性能优化

1. **避免大内存实例**
   - fork()耗时与内存大小成正比
   - 建议单实例<10GB

2. **低峰期保存**
   ```conf
   # 设置在业务低峰期
   save 3600 1  # 每小时保存一次
   ```

3. **禁用自动保存**
   ```conf
   # 手动控制保存时机
   save ""
   ```

## 数据一致性

### 一致性保证

详见：[证明图网-RDB持久化一致性证明](../../00-项目总览/证明图网-核心机制证明.md#2-rdb持久化一致性证明)

**关键点**：
1. **快照原子性**：fork()瞬间捕获内存状态
2. **隔离性**：子进程独立地址空间
3. **持久性**：rename()原子替换文件

### 数据丢失风险

**风险窗口**：两次快照之间的数据修改可能丢失

```
时间线：
T1: 创建快照1（包含数据A）
T2: 修改数据A → A'
T3: 创建快照2（包含数据A'）
T4: 服务器崩溃

如果T4发生在T1和T3之间，数据A'会丢失
```

**解决方案**：
- 缩短快照间隔
- 结合AOF使用混合持久化

## 文件恢复

### 恢复流程

```c
// Redis启动时加载RDB
int loadDataFromDisk(void) {
    long long start = ustime();

    if (server.aof_state == AOF_OFF) {
        // 加载RDB文件
        rdbLoad(server.rdb_filename);
    }

    // 记录加载时间
    server.stat_rdb_load_time = ustime()-start;
}
```

### 恢复性能

| 数据量 | RDB文件大小 | 恢复时间 |
|--------|-------------|----------|
| 1GB | ~500MB | ~5秒 |
| 10GB | ~5GB | ~50秒 |
| 100GB | ~50GB | ~500秒 |

## 优缺点分析

### 优势

| 特性 | 说明 |
|------|------|
| **文件紧凑** | 二进制格式，文件小 |
| **恢复快速** | 直接加载到内存 |
| **性能影响小** | fork子进程，主进程不阻塞 |
| **适合备份** | 可以定期备份RDB文件 |

### 劣势

| 特性 | 说明 |
|------|------|
| **数据丢失** | 两次快照间数据可能丢失 |
| **fork阻塞** | 大数据量时fork耗时较长 |
| **COW开销** | BGSAVE期间写入会触发COW |
| **不实时** | 无法做到秒级持久化 |

## 配置建议

### 生产环境配置

```conf
# 1. 设置合理的保存条件
save 3600 1000    # 1小时内1000次修改

# 2. 禁用自动保存（手动控制）
# save ""

# 3. 设置RDB文件路径
dir /data/redis/rdb

# 4. 启用压缩
rdbcompression yes

# 5. 校验和
rdbchecksum yes
```

### 监控指标

```bash
# 查看RDB相关信息
127.0.0.1:6379> INFO persistence

# 关键指标
rdb_last_save_time:1234567890      # 上次保存时间
rdb_changes_since_last_save:100    # 上次保存后的修改次数
rdb_last_bgsave_status:ok          # 上次BGSAVE状态
rdb_last_bgsave_time_sec:5         # 上次BGSAVE耗时
```

## 扩展阅读

- [AOF日志机制](./03.02.02-AOF日志机制.md)
- [混合持久化](./03.02.03-混合持久化.md)
- [RDB持久化一致性证明](../../00-项目总览/证明图网-核心机制证明.md#2-rdb持久化一致性证明)

## 权威参考

- **Redis源码** - https://github.com/redis/redis
- **《Redis设计与实现》** - 黄健宏著
- **Redis官方文档** - https://redis.io/docs/manual/persistence/
