# 05.05.04 哈希算法实现

## 概述

哈希算法是Redis数据结构和分布式系统的核心，用于快速定位数据、实现一致性哈希、计算数据指纹等。理解Redis中的哈希算法实现对于优化性能和保证数据分布至关重要。

## Redis哈希算法

### 1. MurmurHash2

```c
// Redis使用MurmurHash2（dict.c）
uint32_t dictGenHashFunction(const void *key, int len) {
    // Redis 3.0之前使用djb hash
    // Redis 3.0+使用MurmurHash2

    return MurmurHash2(key, len, 5381);
}

// MurmurHash2实现
uint32_t MurmurHash2(const void *key, int len, uint32_t seed) {
    const uint32_t m = 0x5bd1e995;
    const int r = 24;
    uint32_t h = seed ^ len;

    const unsigned char *data = (const unsigned char *)key;

    while (len >= 4) {
        uint32_t k = *(uint32_t *)data;

        k *= m;
        k ^= k >> r;
        k *= m;

        h *= m;
        h ^= k;

        data += 4;
        len -= 4;
    }

    switch(len) {
        case 3: h ^= data[2] << 16;
        case 2: h ^= data[1] << 8;
        case 1: h ^= data[0];
                h *= m;
    }

    h ^= h >> 13;
    h *= m;
    h ^= h >> 15;

    return h;
}
```

### 2. SipHash

```c
// Redis使用SipHash（防止Hash DoS攻击）
uint64_t siphash(const uint8_t *in, const size_t inlen,
                 const uint8_t *k) {
    // SipHash实现
    // 用于计算字符串哈希值
    // 防止Hash DoS攻击
}
```

### 3. CRC64

```c
// Redis使用CRC64（校验和）
uint64_t crc64(uint64_t crc, const unsigned char *s, uint64_t l) {
    // CRC64实现
    // 用于计算校验和
    // 用于AOF校验等场景
}
```

## 哈希表应用

### 1. dict哈希表

```c
// dict使用MurmurHash2
unsigned int dictGenHashFunction(const void *key, int len) {
    return MurmurHash2(key, len, dict_hash_function_seed);
}

// 哈希表查找
dictEntry *dictFind(dict *d, const void *key) {
    dictEntry *he;
    unsigned int h, idx, table;

    if (d->ht[0].used + d->ht[1].used == 0) return NULL;

    // 计算哈希值
    h = dictHashKey(d, key);

    // 在两个表中查找
    for (table = 0; table <= 1; table++) {
        idx = h & d->ht[table].sizemask;
        he = d->ht[table].table[idx];

        while(he) {
            if (key==he->key || dictCompareKeys(d, key, he->key))
                return he;
            he = he->next;
        }

        if (!dictIsRehashing(d)) break;
    }

    return NULL;
}
```

### 2. 一致性哈希

```c
// 一致性哈希（Redis Cluster）
uint16_t crc16(const char *buf, int len) {
    // CRC16实现
    // 用于计算slot
}

// 计算key的slot
unsigned int keyHashSlot(char *key, int keylen) {
    int s, e;

    // 查找{...}中的内容
    for (s = 0; s < keylen; s++)
        if (key[s] == '{') break;

    if (s == keylen) return crc16(key, keylen) & 0x3FFF;

    for (e = s+1; e < keylen; e++)
        if (key[e] == '}') break;

    if (e == keylen || e == s+1) return crc16(key, keylen) & 0x3FFF;

    return crc16(key+s+1, e-s-1) & 0x3FFF;
}
```

## 性能优化

### 1. 哈希函数选择

```c
// 哈希函数选择
// 1. MurmurHash2：快速、分布均匀
// 2. SipHash：安全、防止DoS
// 3. CRC64：校验和、错误检测
```

### 2. 哈希表大小优化

```c
// 哈希表大小优化
// 1. 使用2的幂次方大小
// 2. 负载因子控制（0.75）
// 3. 渐进式Rehash
```

### 3. 哈希冲突处理

```c
// 哈希冲突处理（链地址法）
// 1. 使用链表存储冲突元素
// 2. 负载因子过高时Rehash
// 3. 渐进式Rehash减少延迟
```

## 性能测试

### 1. 哈希函数性能

```c
// 哈希函数性能测试
void test_hash_performance(void) {
    const char *key = "test_key";
    int len = strlen(key);

    // 测试MurmurHash2
    clock_t start = clock();
    for (int i = 0; i < 1000000; i++) {
        MurmurHash2(key, len, 5381);
    }
    clock_t murmur_time = clock() - start;

    // 测试djb hash
    start = clock();
    for (int i = 0; i < 1000000; i++) {
        djb_hash(key, len);
    }
    clock_t djb_time = clock() - start;

    printf("MurmurHash2: %ld, djb: %ld\n", murmur_time, djb_time);
}
```

### 2. 分布均匀性测试

```c
// 哈希分布均匀性测试
void test_hash_distribution(void) {
    int buckets[100] = {0};

    for (int i = 0; i < 10000; i++) {
        char key[32];
        sprintf(key, "key_%d", i);
        uint32_t hash = MurmurHash2(key, strlen(key), 5381);
        buckets[hash % 100]++;
    }

    // 计算方差
    int sum = 0;
    for (int i = 0; i < 100; i++) {
        sum += buckets[i];
    }
    float mean = sum / 100.0;

    float variance = 0;
    for (int i = 0; i < 100; i++) {
        variance += (buckets[i] - mean) * (buckets[i] - mean);
    }
    variance /= 100;

    printf("Variance: %.2f\n", variance);
}
```

## 扩展阅读

- [哈希表dict实现](../../03-Redis组件/03.01-核心数据结构/03.01.02-哈希表dict实现.md)
- [一致性哈希原理](../../01-理论基础/01.03-分布式缓存算法/01.03.01-一致性哈希原理.md)
- [Cluster集群模式](../../03-Redis组件/03.03-高可用架构/03.03.03-Cluster集群模式.md)

## 权威参考

- **Redis源码** - <https://github.com/redis/redis>
- **《Redis设计与实现》** - 黄健宏著
- **MurmurHash论文** - "MurmurHash: An Extremely Fast Non-Cryptographic Hash Function"
