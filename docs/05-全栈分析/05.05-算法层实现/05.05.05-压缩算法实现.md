# 05.05.05 压缩算法实现

## 概述

压缩算法是Redis内存优化的重要手段，通过压缩数据减少内存占用。Redis支持多种压缩算法，包括LZF、zstd等。理解压缩算法实现对于优化Redis内存使用至关重要。

## Redis压缩算法

### 1. LZF压缩

```c
// LZF压缩算法（Redis默认）
// 快速压缩算法，适合实时压缩

unsigned int lzf_compress(const void *const in_data,
                          unsigned int in_len,
                          void *out_data,
                          unsigned int out_len) {
    // LZF压缩实现
    // 1. 查找重复字符串
    // 2. 使用引用替换重复字符串
    // 3. 返回压缩后长度
}
```

### 2. zstd压缩

```c
// zstd压缩算法（Redis 6.0+）
// 高性能压缩算法，压缩率高

size_t zstd_compress(const void *src, size_t srcSize,
                     void *dst, size_t dstCapacity,
                     int compressionLevel) {
    // zstd压缩实现
    // 1. 使用zstd库压缩
    // 2. 支持多级压缩
    // 3. 返回压缩后大小
}
```

### 3. 无压缩

```c
// 无压缩（某些场景）
// 1. 数据已经压缩
// 2. 压缩开销大于收益
// 3. 实时性要求高
```

## 压缩应用

### 1. quicklist压缩

```c
// quicklist节点压缩
void quicklistCompressNode(quicklistNode *node) {
    if (node->sz < MIN_COMPRESS_BYTES) return;

    // 压缩ziplist
    unsigned char *compressed = lzf_compress(
        node->zl, node->sz,
        node->compressed, node->sz
    );

    if (compressed) {
        node->compressed = compressed;
        node->encoding = QUICKLIST_NODE_ENCODING_LZF;
    }
}
```

### 2. RDB压缩

```c
// RDB文件压缩
int rdbSave(char *filename) {
    // ...

    // 写入压缩数据
    if (server.rdb_compression) {
        // 使用LZF或zstd压缩
        compressed = compress_data(data, data_len);
        write(fd, compressed, compressed_len);
    } else {
        write(fd, data, data_len);
    }

    // ...
}
```

### 3. 客户端压缩

```c
// 客户端压缩（RESP3）
// 1. 客户端发送压缩数据
// 2. Redis解压后处理
// 3. 响应可选择压缩
```

## 压缩策略

### 1. 压缩阈值

```conf
# redis.conf
# quicklist压缩配置
list-compress-depth 1  # 压缩深度（两端保留的节点数）

# 压缩阈值
# 小于阈值不压缩，大于阈值压缩
```

### 2. 压缩级别

```conf
# redis.conf
# zstd压缩级别（1-22）
# 1：最快，压缩率低
# 22：最慢，压缩率高
zstd-compression-level 3
```

### 3. 压缩选择

```python
# 压缩算法选择
class CompressionSelection:
    def recommend(self, data_type, data_size):
        """推荐压缩算法"""
        if data_type == 'quicklist':
            return 'LZF'  # 快速压缩
        elif data_type == 'rdb':
            return 'zstd'  # 高压缩率
        elif data_size < 100:
            return 'none'  # 太小不压缩
        else:
            return 'LZF'  # 默认
```

## 性能分析

### 1. 压缩率

```python
# 压缩率对比
class CompressionRatio:
    def compare(self):
        return {
            'LZF': {
                'ratio': '2-3x',
                'speed': 'fast',
            },
            'zstd': {
                'ratio': '3-5x',
                'speed': 'medium',
            },
            'gzip': {
                'ratio': '4-6x',
                'speed': 'slow',
            },
        }
```

### 2. 压缩开销

```python
# 压缩开销
class CompressionOverhead:
    def analyze(self):
        return {
            'cpu_overhead': '5-20%',
            'memory_overhead': '10-30%',
            'latency_impact': '<5%',
        }
```

## 扩展阅读

- [quicklist列表实现](../../03-Redis组件/03.01-核心数据结构/03.01.03-列表quicklist实现.md)
- [ziplist压缩编码](../../03-Redis组件/03.01-核心数据结构/03.01.06-压缩编码ziplist.md)
- [RDB快照机制](../../03-Redis组件/03.02-持久化机制/03.02.01-RDB快照机制.md)

## 权威参考

- **Redis源码** - <https://github.com/redis/redis>
- **《Redis设计与实现》** - 黄健宏著
- **LZF文档** - <http://oldhome.schmorp.de/marc/liblzf.html>
- **zstd文档** - <https://github.com/facebook/zstd>
