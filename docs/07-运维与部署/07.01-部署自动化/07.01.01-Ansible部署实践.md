# 07.01.01 Ansible部署实践

## 目录

- [07.01.01 Ansible部署实践](#070101-ansible部署实践)
  - [目录](#目录)
  - [1. 概述](#1-概述)
    - [1.1 定义与背景](#11-定义与背景)
    - [1.2 应用价值](#12-应用价值)
  - [2. Ansible基础](#2-ansible基础)
    - [2.1 安装Ansible](#21-安装ansible)
    - [2.2 基本概念](#22-基本概念)
  - [3. Redis单机部署](#3-redis单机部署)
    - [3.1 Playbook结构](#31-playbook结构)
    - [3.2 Redis配置文件模板](#32-redis配置文件模板)
    - [3.3 变量定义](#33-变量定义)
    - [3.4 完整Playbook](#34-完整playbook)
  - [4. Redis Sentinel部署](#4-redis-sentinel部署)
    - [4.1 Sentinel Playbook](#41-sentinel-playbook)
    - [4.2 Sentinel配置模板](#42-sentinel配置模板)
    - [4.3 Sentinel部署Playbook](#43-sentinel部署playbook)
  - [5. Redis Cluster部署](#5-redis-cluster部署)
    - [5.1 Cluster节点部署](#51-cluster节点部署)
    - [5.2 Cluster配置模板](#52-cluster配置模板)
    - [5.3 Cluster初始化](#53-cluster初始化)
    - [5.4 Cluster部署Playbook](#54-cluster部署playbook)
  - [6. 多环境部署策略](#6-多环境部署策略)
    - [6.1 环境变量文件](#61-环境变量文件)
    - [6.2 环境特定Inventory](#62-环境特定inventory)
    - [6.3 多环境部署命令](#63-多环境部署命令)
  - [7. 配置管理最佳实践](#7-配置管理最佳实践)
    - [7.1 使用Vault加密敏感信息](#71-使用vault加密敏感信息)
    - [7.2 配置版本管理](#72-配置版本管理)
    - [7.3 配置验证](#73-配置验证)
  - [8. 部署验证](#8-部署验证)
    - [8.1 健康检查脚本](#81-健康检查脚本)
    - [8.2 部署后验证Playbook](#82-部署后验证playbook)
  - [9. 扩展阅读](#9-扩展阅读)
  - [10. 权威参考](#10-权威参考)
    - [10.1 官方文档](#101-官方文档)
    - [10.2 经典书籍](#102-经典书籍)
    - [10.3 在线资源](#103-在线资源)

---

## 1. 概述

### 1.1 定义与背景

**Ansible**是一个自动化IT工具，用于配置管理、应用部署、任务自动化等。Ansible使用SSH协议，无需在目标主机安装代理，通过Playbook描述自动化任务。

**Ansible优势**：

- ✅ **无代理架构**：无需在目标主机安装代理
- ✅ **幂等性**：多次执行结果一致
- ✅ **易学易用**：YAML语法，易于理解和维护
- ✅ **模块丰富**：大量内置模块和社区模块

### 1.2 应用价值

Ansible在Redis部署中的价值：

1. **自动化部署**：一键部署Redis单机、Sentinel、Cluster
2. **配置管理**：统一管理Redis配置文件
3. **多环境支持**：支持开发、测试、生产环境
4. **可重复性**：确保部署结果一致

---

## 2. Ansible基础

### 2.1 安装Ansible

**Ubuntu/Debian**：

```bash
sudo apt update
sudo apt install ansible
```

**CentOS/RHEL**：

```bash
sudo yum install ansible
```

**macOS**：

```bash
brew install ansible
```

**Python pip**：

```bash
pip install ansible
```

### 2.2 基本概念

**Inventory（清单）**：定义目标主机列表

```ini
# inventory.ini
[redis-masters]
redis-master-1 ansible_host=192.168.1.10
redis-master-2 ansible_host=192.168.1.11

[redis-slaves]
redis-slave-1 ansible_host=192.168.1.20
redis-slave-2 ansible_host=192.168.1.21

[redis-cluster:children]
redis-masters
redis-slaves
```

**Playbook（剧本）**：描述自动化任务

```yaml
# playbook.yml
- hosts: redis-masters
  become: yes
  tasks:
    - name: Install Redis
      apt:
        name: redis-server
        state: present
```

**Module（模块）**：执行具体任务的功能单元

**Task（任务）**：Playbook中的单个操作

**Role（角色）**：可重用的任务集合

---

## 3. Redis单机部署

### 3.1 Playbook结构

```yaml
# roles/redis-single/tasks/main.yml
---
- name: Install Redis
  apt:
    name: redis-server
    state: present
  when: ansible_os_family == "Debian"

- name: Install Redis (RedHat)
  yum:
    name: redis
    state: present
  when: ansible_os_family == "RedHat"

- name: Create Redis config directory
  file:
    path: /etc/redis
    state: directory
    mode: '0755'

- name: Configure Redis
  template:
    src: redis.conf.j2
    dest: /etc/redis/redis.conf
    mode: '0644'
  notify: restart redis

- name: Start and enable Redis
  systemd:
    name: redis-server
    state: started
    enabled: yes
```

### 3.2 Redis配置文件模板

```jinja2
# roles/redis-single/templates/redis.conf.j2
# Redis configuration file

# Network
bind {{ redis_bind }}
port {{ redis_port }}
protected-mode {{ redis_protected_mode | lower }}

# General
daemonize yes
pidfile /var/run/redis/redis-server.pid
loglevel {{ redis_loglevel }}
logfile /var/log/redis/redis-server.log

# Snapshotting
save 900 1
save 300 10
save 60 10000
dir {{ redis_data_dir }}
dbfilename dump.rdb

# Memory
maxmemory {{ redis_maxmemory }}
maxmemory-policy {{ redis_maxmemory_policy }}

# AOF
appendonly {{ redis_appendonly | lower }}
appendfilename "appendonly.aof"
appendfsync {{ redis_appendfsync }}
```

### 3.3 变量定义

```yaml
# roles/redis-single/defaults/main.yml
---
redis_bind: "0.0.0.0"
redis_port: 6379
redis_protected_mode: "yes"
redis_loglevel: "notice"
redis_data_dir: "/var/lib/redis"
redis_maxmemory: "2gb"
redis_maxmemory_policy: "allkeys-lru"
redis_appendonly: "yes"
redis_appendfsync: "everysec"
```

### 3.4 完整Playbook

```yaml
# deploy-redis-single.yml
---
- hosts: redis-single
  become: yes
  vars:
    redis_version: "7.0"
    redis_port: 6379
    redis_maxmemory: "2gb"

  roles:
    - redis-single

  handlers:
    - name: restart redis
      systemd:
        name: redis-server
        state: restarted
```

**执行命令**：

```bash
ansible-playbook -i inventory.ini deploy-redis-single.yml
```

---

## 4. Redis Sentinel部署

### 4.1 Sentinel Playbook

```yaml
# roles/redis-sentinel/tasks/main.yml
---
- name: Install Redis
  apt:
    name: redis-server
    state: present

- name: Create Sentinel config directory
  file:
    path: /etc/redis
    state: directory
    mode: '0755'

- name: Configure Sentinel
  template:
    src: sentinel.conf.j2
    dest: /etc/redis/sentinel.conf
    mode: '0644'
  notify: restart sentinel

- name: Start and enable Sentinel
  systemd:
    name: redis-sentinel
    state: started
    enabled: yes
```

### 4.2 Sentinel配置模板

```jinja2
# roles/redis-sentinel/templates/sentinel.conf.j2
# Sentinel configuration file

port {{ sentinel_port }}

# Sentinel monitor
sentinel monitor {{ sentinel_master_name }} {{ sentinel_master_host }} {{ sentinel_master_port }} {{ sentinel_quorum }}

# Sentinel down-after-milliseconds
sentinel down-after-milliseconds {{ sentinel_master_name }} {{ sentinel_down_after }}

# Sentinel parallel-syncs
sentinel parallel-syncs {{ sentinel_master_name }} {{ sentinel_parallel_syncs }}

# Sentinel failover-timeout
sentinel failover-timeout {{ sentinel_master_name }} {{ sentinel_failover_timeout }}

# Sentinel log
logfile /var/log/redis/sentinel.log
```

### 4.3 Sentinel部署Playbook

```yaml
# deploy-redis-sentinel.yml
---
- hosts: redis-masters
  become: yes
  vars:
    redis_role: "master"
  roles:
    - redis-single

- hosts: redis-slaves
  become: yes
  vars:
    redis_role: "slave"
    redis_master_host: "{{ hostvars[groups['redis-masters'][0]]['ansible_host'] }}"
    redis_master_port: 6379
  roles:
    - redis-single

- hosts: redis-sentinels
  become: yes
  vars:
    sentinel_port: 26379
    sentinel_master_name: "mymaster"
    sentinel_master_host: "{{ hostvars[groups['redis-masters'][0]]['ansible_host'] }}"
    sentinel_master_port: 6379
    sentinel_quorum: 2
    sentinel_down_after: 5000
    sentinel_parallel_syncs: 1
    sentinel_failover_timeout: 10000
  roles:
    - redis-sentinel
```

**执行命令**：

```bash
ansible-playbook -i inventory.ini deploy-redis-sentinel.yml
```

---

## 5. Redis Cluster部署

### 5.1 Cluster节点部署

```yaml
# roles/redis-cluster/tasks/main.yml
---
- name: Install Redis
  apt:
    name: redis-server
    state: present

- name: Create Redis cluster config directory
  file:
    path: /etc/redis/cluster
    state: directory
    mode: '0755'

- name: Configure Redis for Cluster
  template:
    src: redis-cluster.conf.j2
    dest: /etc/redis/cluster/redis-{{ redis_cluster_port }}.conf
    mode: '0644'
  notify: restart redis cluster

- name: Start Redis Cluster node
  systemd:
    name: redis-cluster@{{ redis_cluster_port }}
    state: started
    enabled: yes
```

### 5.2 Cluster配置模板

```jinja2
# roles/redis-cluster/templates/redis-cluster.conf.j2
# Redis Cluster configuration

port {{ redis_cluster_port }}
cluster-enabled yes
cluster-config-file nodes-{{ redis_cluster_port }}.conf
cluster-node-timeout {{ redis_cluster_node_timeout }}
appendonly yes
dir /var/lib/redis/cluster-{{ redis_cluster_port }}
```

### 5.3 Cluster初始化

```yaml
# roles/redis-cluster/tasks/cluster-init.yml
---
- name: Get cluster nodes
  set_fact:
    cluster_nodes: "{{ groups['redis-cluster'] | map('extract', hostvars, 'ansible_host') | list }}"

- name: Initialize Redis Cluster
  shell: |
    redis-cli --cluster create \
      {% for node in cluster_nodes %}
      {{ node }}:{{ redis_cluster_port }}{% if not loop.last %} \{% endif %}
      {% endfor %} \
      --cluster-replicas {{ redis_cluster_replicas }}
  delegate_to: "{{ groups['redis-cluster'][0] }}"
  when: cluster_init | default(false)
```

### 5.4 Cluster部署Playbook

```yaml
# deploy-redis-cluster.yml
---
- hosts: redis-cluster
  become: yes
  vars:
    redis_cluster_port: 7000
    redis_cluster_node_timeout: 5000
    redis_cluster_replicas: 1
  roles:
    - redis-cluster

- hosts: redis-cluster[0]
  become: yes
  vars:
    cluster_init: true
  tasks:
    - include_role:
        name: redis-cluster
        tasks_from: cluster-init
```

**执行命令**：

```bash
ansible-playbook -i inventory.ini deploy-redis-cluster.yml
```

---

## 6. 多环境部署策略

### 6.1 环境变量文件

**开发环境** (`group_vars/dev.yml`)：

```yaml
---
redis_port: 6379
redis_maxmemory: "512mb"
redis_appendonly: "no"
redis_loglevel: "debug"
```

**测试环境** (`group_vars/test.yml`)：

```yaml
---
redis_port: 6379
redis_maxmemory: "1gb"
redis_appendonly: "yes"
redis_loglevel: "notice"
```

**生产环境** (`group_vars/prod.yml`)：

```yaml
---
redis_port: 6379
redis_maxmemory: "8gb"
redis_appendonly: "yes"
redis_loglevel: "warning"
redis_protected_mode: "yes"
redis_requirepass: "{{ vault_redis_password }}"
```

### 6.2 环境特定Inventory

**开发环境** (`inventory/dev.ini`)：

```ini
[redis-single]
dev-redis-1 ansible_host=10.0.1.10
```

**测试环境** (`inventory/test.ini`)：

```ini
[redis-single]
test-redis-1 ansible_host=10.0.2.10
```

**生产环境** (`inventory/prod.ini`)：

```ini
[redis-single]
prod-redis-1 ansible_host=10.0.3.10
```

### 6.3 多环境部署命令

```bash
# 开发环境
ansible-playbook -i inventory/dev.ini deploy-redis-single.yml

# 测试环境
ansible-playbook -i inventory/test.ini deploy-redis-single.yml

# 生产环境
ansible-playbook -i inventory/prod.ini deploy-redis-single.yml --ask-vault-pass
```

---

## 7. 配置管理最佳实践

### 7.1 使用Vault加密敏感信息

**创建加密文件**：

```bash
ansible-vault create group_vars/prod/vault.yml
```

**加密文件内容**：

```yaml
---
vault_redis_password: "secure_password_here"
vault_redis_master_password: "master_password_here"
```

**使用加密变量**：

```yaml
redis_requirepass: "{{ vault_redis_password }}"
```

### 7.2 配置版本管理

**Git仓库结构**：

```text
ansible-redis/
├── inventory/
│   ├── dev.ini
│   ├── test.ini
│   └── prod.ini
├── group_vars/
│   ├── dev.yml
│   ├── test.yml
│   └── prod/
│       ├── vars.yml
│       └── vault.yml
├── roles/
│   ├── redis-single/
│   ├── redis-sentinel/
│   └── redis-cluster/
└── playbooks/
    ├── deploy-redis-single.yml
    ├── deploy-redis-sentinel.yml
    └── deploy-redis-cluster.yml
```

### 7.3 配置验证

```yaml
# roles/redis-single/tasks/verify.yml
---
- name: Verify Redis is running
  uri:
    url: "http://{{ ansible_host }}:{{ redis_port }}"
    method: GET
  register: redis_status
  failed_when: redis_status.status != 200

- name: Verify Redis configuration
  command: redis-cli CONFIG GET maxmemory
  register: redis_config
  changed_when: false
```

---

## 8. 部署验证

### 8.1 健康检查脚本

```yaml
# roles/redis-single/tasks/health-check.yml
---
- name: Check Redis connectivity
  command: redis-cli -h {{ ansible_host }} -p {{ redis_port }} PING
  register: redis_ping
  failed_when: redis_ping.stdout != "PONG"

- name: Check Redis info
  command: redis-cli -h {{ ansible_host }} -p {{ redis_port }} INFO server
  register: redis_info
  changed_when: false

- name: Display Redis version
  debug:
    msg: "Redis version: {{ redis_info.stdout | regex_search('redis_version:(.*)', '\\1') | first }}"
```

### 8.2 部署后验证Playbook

```yaml
# verify-deployment.yml
---
- hosts: redis-single
  become: yes
  tasks:
    - include_role:
        name: redis-single
        tasks_from: health-check

- hosts: redis-sentinels
  become: yes
  tasks:
    - name: Check Sentinel status
      command: redis-cli -p 26379 SENTINEL masters
      register: sentinel_status
      changed_when: false

- hosts: redis-cluster
  become: yes
  tasks:
    - name: Check Cluster status
      command: redis-cli -p 7000 CLUSTER INFO
      register: cluster_status
      changed_when: false
```

**执行验证**：

```bash
ansible-playbook -i inventory.ini verify-deployment.yml
```

---

## 9. 扩展阅读

- [Redis Sentinel部署实践](../07.05-集群管理/07.05.01-集群部署实践.md)
- [Redis Cluster部署实践](../07.05-集群管理/07.05.01-集群部署实践.md)
- [Terraform基础设施即代码](07.01.02-Terraform基础设施即代码.md)
- [Helm Chart实践](07.01.03-Helm-Chart实践.md)

---

## 10. 权威参考

### 10.1 官方文档

- [Ansible官方文档](https://docs.ansible.com/)
- [Ansible最佳实践](https://docs.ansible.com/ansible/latest/user_guide/playbooks_best_practices.html)
- [Redis官方文档](https://redis.io/docs/)

### 10.2 经典书籍

- **《Ansible自动化运维：技术与最佳实践》** - 作者：陈金窗，ISBN：9787111551234
- **《Redis设计与实现》** - 作者：黄健宏，ISBN：9787111464747

### 10.3 在线资源

- [Ansible Galaxy](https://galaxy.ansible.com/) - Ansible角色和集合
- [Redis最佳实践](https://redis.io/docs/manual/patterns/)

---

**文档版本**：v1.0
**最后更新**：2025-01
**文档状态**：✅ 完成
