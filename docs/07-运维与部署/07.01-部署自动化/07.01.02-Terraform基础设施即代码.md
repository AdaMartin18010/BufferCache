# 07.01.02 Terraform基础设施即代码

## 目录

- [07.01.02 Terraform基础设施即代码](#070102-terraform基础设施即代码)
  - [目录](#目录)
  - [1. 概述](#1-概述)
    - [1.1 定义与背景](#11-定义与背景)
    - [1.2 应用价值](#12-应用价值)
  - [2. Terraform基础](#2-terraform基础)
    - [2.1 安装Terraform](#21-安装terraform)
    - [2.2 基本概念](#22-基本概念)
  - [3. AWS Redis集群部署](#3-aws-redis集群部署)
    - [3.1 Provider配置](#31-provider配置)
    - [3.2 变量定义](#32-变量定义)
    - [3.3 ElastiCache Redis配置](#33-elasticache-redis配置)
    - [3.4 安全组配置](#34-安全组配置)
    - [3.5 输出配置](#35-输出配置)
    - [3.6 部署命令](#36-部署命令)
  - [4. 阿里云Redis集群部署](#4-阿里云redis集群部署)
    - [4.1 Provider配置](#41-provider配置)
    - [4.2 Redis实例配置](#42-redis实例配置)
  - [5. 腾讯云Redis集群部署](#5-腾讯云redis集群部署)
    - [5.1 Provider配置](#51-provider配置)
    - [5.2 Redis实例配置](#52-redis实例配置)
  - [6. 多地域部署实践](#6-多地域部署实践)
    - [6.1 模块化设计](#61-模块化设计)
  - [7. 网络配置与安全](#7-网络配置与安全)
    - [7.1 VPC配置](#71-vpc配置)
    - [7.2 加密配置](#72-加密配置)
  - [8. 扩展阅读](#8-扩展阅读)
  - [9. 权威参考](#9-权威参考)
    - [9.1 官方文档](#91-官方文档)
    - [9.2 经典书籍](#92-经典书籍)

---

## 1. 概述

### 1.1 定义与背景

**Terraform**是HashiCorp开发的基础设施即代码（Infrastructure as Code, IaC）工具，用于安全、高效地构建、更改和版本化基础设施。

**Terraform优势**：

- ✅ **多云支持**：支持AWS、Azure、GCP、阿里云、腾讯云等
- ✅ **声明式语法**：描述期望状态，自动计算变更
- ✅ **状态管理**：跟踪基础设施状态
- ✅ **模块化**：可重用的模块设计

### 1.2 应用价值

Terraform在Redis部署中的价值：

1. **基础设施自动化**：自动化创建云资源
2. **版本控制**：基础设施配置版本化管理
3. **多环境支持**：开发、测试、生产环境统一管理
4. **成本控制**：精确控制资源创建和销毁

---

## 2. Terraform基础

### 2.1 安装Terraform

**macOS**：

```bash
brew install terraform
```

**Linux**：

```bash
wget https://releases.hashicorp.com/terraform/1.6.0/terraform_1.6.0_linux_amd64.zip
unzip terraform_1.6.0_linux_amd64.zip
sudo mv terraform /usr/local/bin/
```

**Windows**：
下载并解压到PATH目录

### 2.2 基本概念

**Provider（提供商）**：云服务提供商插件

**Resource（资源）**：基础设施组件

**Module（模块）**：可重用的资源集合

**State（状态）**：基础设施当前状态

**Variable（变量）**：配置参数

**Output（输出）**：资源信息输出

---

## 3. AWS Redis集群部署

### 3.1 Provider配置

```hcl
# main.tf
terraform {
  required_version = ">= 1.0"

  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~> 5.0"
    }
  }
}

provider "aws" {
  region = var.aws_region
}
```

### 3.2 变量定义

```hcl
# variables.tf
variable "aws_region" {
  description = "AWS region"
  type        = string
  default     = "us-east-1"
}

variable "redis_cluster_name" {
  description = "Redis cluster name"
  type        = string
  default     = "redis-cluster"
}

variable "redis_node_type" {
  description = "Redis node instance type"
  type        = string
  default     = "cache.t3.micro"
}

variable "redis_num_cache_nodes" {
  description = "Number of cache nodes"
  type        = number
  default     = 2
}

variable "redis_engine_version" {
  description = "Redis engine version"
  type        = string
  default     = "7.0"
}
```

### 3.3 ElastiCache Redis配置

```hcl
# redis-cluster.tf
resource "aws_elasticache_subnet_group" "redis" {
  name       = "${var.redis_cluster_name}-subnet-group"
  subnet_ids = var.subnet_ids
}

resource "aws_elasticache_replication_group" "redis" {
  replication_group_id       = var.redis_cluster_name
  description                = "Redis cluster for ${var.redis_cluster_name}"

  engine                     = "redis"
  engine_version             = var.redis_engine_version
  node_type                  = var.redis_node_type
  num_cache_clusters         = var.redis_num_cache_nodes

  port                       = 6379
  parameter_group_name       = "default.redis7"

  subnet_group_name          = aws_elasticache_subnet_group.redis.name
  security_group_ids         = [aws_security_group.redis.id]

  automatic_failover_enabled = true
  multi_az_enabled          = true

  at_rest_encryption_enabled = true
  transit_encryption_enabled = true

  snapshot_retention_limit   = 5
  snapshot_window            = "03:00-05:00"

  tags = {
    Name        = var.redis_cluster_name
    Environment = var.environment
  }
}
```

### 3.4 安全组配置

```hcl
# security-group.tf
resource "aws_security_group" "redis" {
  name        = "${var.redis_cluster_name}-sg"
  description = "Security group for Redis cluster"
  vpc_id      = var.vpc_id

  ingress {
    description = "Redis port"
    from_port   = 6379
    to_port     = 6379
    protocol    = "tcp"
    cidr_blocks = [var.vpc_cidr]
  }

  egress {
    from_port   = 0
    to_port     = 0
    protocol    = "-1"
    cidr_blocks = ["0.0.0.0/0"]
  }

  tags = {
    Name = "${var.redis_cluster_name}-sg"
  }
}
```

### 3.5 输出配置

```hcl
# outputs.tf
output "redis_endpoint" {
  description = "Redis primary endpoint"
  value       = aws_elasticache_replication_group.redis.primary_endpoint_address
}

output "redis_reader_endpoint" {
  description = "Redis reader endpoint"
  value       = aws_elasticache_replication_group.redis.reader_endpoint_address
}

output "redis_port" {
  description = "Redis port"
  value       = aws_elasticache_replication_group.redis.port
}
```

### 3.6 部署命令

```bash
# 初始化
terraform init

# 规划变更
terraform plan

# 应用变更
terraform apply

# 销毁资源
terraform destroy
```

---

## 4. 阿里云Redis集群部署

### 4.1 Provider配置

```hcl
# main.tf
terraform {
  required_providers {
    alicloud = {
      source  = "aliyun/alicloud"
      version = "~> 1.200"
    }
  }
}

provider "alicloud" {
  region = var.alicloud_region
  access_key = var.alicloud_access_key
  secret_key = var.alicloud_secret_key
}
```

### 4.2 Redis实例配置

```hcl
# redis-instance.tf
resource "alicloud_kvstore_instance" "redis" {
  instance_name     = var.redis_cluster_name
  instance_class    = var.redis_instance_class
  instance_type     = "Redis"
  engine_version    = var.redis_engine_version

  vpc_id            = var.vpc_id
  vswitch_id        = var.vswitch_id
  security_ips      = var.security_ips

  password          = var.redis_password

  payment_type      = "PostPaid"
  period            = 1

  tags = {
    Name        = var.redis_cluster_name
    Environment = var.environment
  }
}
```

---

## 5. 腾讯云Redis集群部署

### 5.1 Provider配置

```hcl
# main.tf
terraform {
  required_providers {
    tencentcloud = {
      source  = "tencentcloudstack/tencentcloud"
      version = "~> 1.80"
    }
  }
}

provider "tencentcloud" {
  region     = var.tencentcloud_region
  secret_id  = var.tencentcloud_secret_id
  secret_key = var.tencentcloud_secret_key
}
```

### 5.2 Redis实例配置

```hcl
# redis-instance.tf
resource "tencentcloud_redis_instance" "redis" {
  name              = var.redis_cluster_name
  type              = var.redis_type
  mem_size          = var.redis_mem_size
  vpc_id            = var.vpc_id
  subnet_id         = var.subnet_id

  password          = var.redis_password

  port              = 6379

  tags = {
    Name        = var.redis_cluster_name
    Environment = var.environment
  }
}
```

---

## 6. 多地域部署实践

### 6.1 模块化设计

```hcl
# modules/redis-cluster/main.tf
resource "aws_elasticache_replication_group" "redis" {
  # ... 配置 ...
}

# modules/redis-cluster/variables.tf
variable "region" {
  type = string
}

variable "environment" {
  type = string
}

# main.tf
module "redis_us_east" {
  source = "./modules/redis-cluster"

  region      = "us-east-1"
  environment = "production"
}

module "redis_us_west" {
  source = "./modules/redis-cluster"

  region      = "us-west-2"
  environment = "production"
}
```

---

## 7. 网络配置与安全

### 7.1 VPC配置

```hcl
# vpc.tf
resource "aws_vpc" "main" {
  cidr_block           = "10.0.0.0/16"
  enable_dns_hostnames = true
  enable_dns_support   = true

  tags = {
    Name = "redis-vpc"
  }
}

resource "aws_subnet" "private" {
  vpc_id            = aws_vpc.main.id
  cidr_block        = "10.0.1.0/24"
  availability_zone = "us-east-1a"

  tags = {
    Name = "redis-private-subnet"
  }
}
```

### 7.2 加密配置

```hcl
# encryption.tf
resource "aws_kms_key" "redis" {
  description = "KMS key for Redis encryption"

  tags = {
    Name = "redis-kms-key"
  }
}

resource "aws_elasticache_replication_group" "redis" {
  # ... 其他配置 ...

  at_rest_encryption_enabled = true
  kms_key_id                 = aws_kms_key.redis.arn
  transit_encryption_enabled  = true
}
```

---

## 8. 扩展阅读

- [Ansible部署实践](07.01.01-Ansible部署实践.md)
- [Helm Chart实践](07.01.03-Helm-Chart实践.md)
- [集群部署实践](../07.05-集群管理/07.05.01-集群部署实践.md)

---

## 9. 权威参考

### 9.1 官方文档

- [Terraform官方文档](https://www.terraform.io/docs)
- [AWS Provider文档](https://registry.terraform.io/providers/hashicorp/aws/latest/docs)
- [阿里云Provider文档](https://registry.terraform.io/providers/aliyun/alicloud/latest/docs)
- [腾讯云Provider文档](https://registry.terraform.io/providers/tencentcloudstack/tencentcloud/latest/docs)

### 9.2 经典书籍

- **《Terraform实战》** - 作者：Scott Winkler，ISBN：9787111681236

---

**文档版本**：v1.0
**最后更新**：2025-01
**文档状态**：✅ 完成
