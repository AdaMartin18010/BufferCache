# 07.01.03 Helm Chart实践

## 目录

- [07.01.03 Helm Chart实践](#070103-helm-chart实践)
  - [目录](#目录)
  - [1. 概述](#1-概述)
  - [2. Helm基础](#2-helm基础)
    - [2.1 安装Helm](#21-安装helm)
    - [2.2 Chart结构](#22-chart结构)
  - [3. Redis单机Chart](#3-redis单机chart)
    - [3.1 Chart.yaml](#31-chartyaml)
    - [3.2 values.yaml](#32-valuesyaml)
    - [3.3 Deployment模板](#33-deployment模板)
  - [4. Redis Sentinel Chart](#4-redis-sentinel-chart)
    - [4.1 Sentinel配置](#41-sentinel配置)
    - [4.2 Sentinel StatefulSet](#42-sentinel-statefulset)
  - [5. Redis Cluster Chart](#5-redis-cluster-chart)
    - [5.1 Cluster配置](#51-cluster配置)
    - [5.2 Cluster StatefulSet](#52-cluster-statefulset)
  - [6. Chart发布与使用](#6-chart发布与使用)
    - [6.1 打包Chart](#61-打包chart)
    - [6.2 安装Chart](#62-安装chart)
    - [6.3 升级Chart](#63-升级chart)
  - [7. 扩展阅读](#7-扩展阅读)
  - [8. 权威参考](#8-权威参考)

---

## 1. 概述

**Helm**是Kubernetes的包管理工具，通过Chart管理Kubernetes应用。

**Helm优势**：

- ✅ 应用打包和版本管理
- ✅ 依赖管理
- ✅ 配置模板化
- ✅ 一键部署和升级

---

## 2. Helm基础

### 2.1 安装Helm

```bash
# macOS
brew install helm

# Linux
curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
```

### 2.2 Chart结构

```text
redis-chart/
├── Chart.yaml          # Chart元数据
├── values.yaml         # 默认配置
├── templates/          # 模板文件
│   ├── deployment.yaml
│   ├── service.yaml
│   └── configmap.yaml
└── charts/             # 依赖Chart
```

---

## 3. Redis单机Chart

### 3.1 Chart.yaml

```yaml
apiVersion: v2
name: redis
description: Redis single instance
type: application
version: 1.0.0
appVersion: "7.0"
```

### 3.2 values.yaml

```yaml
image:
  repository: redis
  tag: "7.0-alpine"
  pullPolicy: IfNotPresent

service:
  type: ClusterIP
  port: 6379

persistence:
  enabled: true
  size: 8Gi

resources:
  requests:
    memory: "512Mi"
    cpu: "250m"
  limits:
    memory: "2Gi"
    cpu: "1000m"
```

### 3.3 Deployment模板

```yaml
# templates/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "redis.fullname" . }}
spec:
  replicas: {{ .Values.replicaCount }}
  selector:
    matchLabels:
      app: {{ include "redis.name" . }}
  template:
    metadata:
      labels:
        app: {{ include "redis.name" . }}
    spec:
      containers:
      - name: redis
        image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
        ports:
        - containerPort: 6379
        volumeMounts:
        - name: data
          mountPath: /data
      volumes:
      - name: data
        persistentVolumeClaim:
          claimName: {{ include "redis.fullname" . }}
```

---

## 4. Redis Sentinel Chart

### 4.1 Sentinel配置

```yaml
# values.yaml
sentinel:
  enabled: true
  replicas: 3
  quorum: 2
```

### 4.2 Sentinel StatefulSet

```yaml
# templates/sentinel-statefulset.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: {{ include "redis.sentinel.fullname" . }}
spec:
  serviceName: {{ include "redis.sentinel.fullname" . }}
  replicas: {{ .Values.sentinel.replicas }}
  # ... 配置 ...
```

---

## 5. Redis Cluster Chart

### 5.1 Cluster配置

```yaml
# values.yaml
cluster:
  enabled: true
  nodes: 6
  replicas: 1
```

### 5.2 Cluster StatefulSet

```yaml
# templates/cluster-statefulset.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: {{ include "redis.cluster.fullname" . }}
spec:
  serviceName: {{ include "redis.cluster.fullname" . }}
  replicas: {{ .Values.cluster.nodes }}
  # ... 配置 ...
```

---

## 6. Chart发布与使用

### 6.1 打包Chart

```bash
helm package redis-chart
```

### 6.2 安装Chart

```bash
helm install redis ./redis-chart
```

### 6.3 升级Chart

```bash
helm upgrade redis ./redis-chart
```

---

## 7. 扩展阅读

- [Ansible部署实践](07.01.01-Ansible部署实践.md)
- [Terraform基础设施即代码](07.01.02-Terraform基础设施即代码.md)
- [容器化环境缓存优化](../../02-系统实现/02.05-系统级优化/02.05.04-容器化环境缓存优化.md)

---

## 8. 权威参考

- [Helm官方文档](https://helm.sh/docs/)
- [Kubernetes官方文档](https://kubernetes.io/docs/)

---

**文档版本**：v1.0
**最后更新**：2025-01
**文档状态**：✅ 完成
