# 07.02.01 GitLab CI实践

## 目录

- [07.02.01 GitLab CI实践](#070201-gitlab-ci实践)
  - [目录](#目录)
  - [1. 概述](#1-概述)
  - [2. GitLab CI配置](#2-gitlab-ci配置)
    - [2.1 .gitlab-ci.yml](#21-gitlab-ciyml)
  - [3. Pipeline阶段](#3-pipeline阶段)
    - [3.1 配置验证](#31-配置验证)
    - [3.2 自动化测试](#32-自动化测试)
    - [3.3 构建镜像](#33-构建镜像)
    - [3.4 部署](#34-部署)
  - [4. 部署Pipeline](#4-部署pipeline)
    - [4.1 开发环境自动部署](#41-开发环境自动部署)
    - [4.2 生产环境手动部署](#42-生产环境手动部署)
  - [5. 扩展阅读](#5-扩展阅读)
  - [6. 权威参考](#6-权威参考)

---

## 1. 概述

GitLab CI实践涵盖GitLab CI Pipeline配置、自动化测试和部署流程。

---

## 2. GitLab CI配置

### 2.1 .gitlab-ci.yml

```yaml
# .gitlab-ci.yml
stages:
  - validate
  - test
  - build
  - deploy

variables:
  REDIS_VERSION: "7.0"

validate_config:
  stage: validate
  script:
    - redis-server --test-memory 1
    - redis-cli --version

test:
  stage: test
  script:
    - pytest tests/
  coverage: '/TOTAL.*\s+(\d+%)$/'

build_image:
  stage: build
  script:
    - docker build -t redis:$CI_COMMIT_SHORT_SHA .
  only:
    - main

deploy_dev:
  stage: deploy
  script:
    - ansible-playbook deploy.yml -i inventory/dev.ini
  environment:
    name: development
  only:
    - develop

deploy_prod:
  stage: deploy
  script:
    - ansible-playbook deploy.yml -i inventory/prod.ini
  environment:
    name: production
  when: manual
  only:
    - main
```

---

## 3. Pipeline阶段

### 3.1 配置验证

验证Redis配置文件语法正确性。

### 3.2 自动化测试

运行单元测试和集成测试。

### 3.3 构建镜像

构建Docker镜像。

### 3.4 部署

自动部署到开发环境，手动部署到生产环境。

---

## 4. 部署Pipeline

### 4.1 开发环境自动部署

每次推送到develop分支自动部署。

### 4.2 生产环境手动部署

需要手动触发，确保安全。

---

## 5. 扩展阅读

- [Jenkins实践](07.02.02-Jenkins实践.md)
- [GitHub Actions实践](07.02.03-GitHub-Actions实践.md)
- [Ansible部署实践](../07.01-部署自动化/07.01.01-Ansible部署实践.md)

---

## 6. 权威参考

- [GitLab CI官方文档](https://docs.gitlab.com/ee/ci/)

---

**文档版本**：v1.0
**最后更新**：2025-01
**文档状态**：✅ 完成
