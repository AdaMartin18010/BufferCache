# 07.03.02 Grafana可视化

## 目录

- [07.03.02 Grafana可视化](#070302-grafana可视化)
  - [目录](#目录)
  - [1. 概述](#1-概述)
  - [2. Grafana部署](#2-grafana部署)
    - [2.1 Docker部署](#21-docker部署)
    - [2.2 Kubernetes部署](#22-kubernetes部署)
    - [2.3 二进制部署](#23-二进制部署)
    - [2.4 高可用部署](#24-高可用部署)
  - [3. 数据源配置](#3-数据源配置)
    - [3.1 Prometheus数据源](#31-prometheus数据源)
    - [3.2 Loki数据源](#32-loki数据源)
    - [3.3 Jaeger数据源](#33-jaeger数据源)
    - [3.4 多数据源配置](#34-多数据源配置)
  - [4. Dashboard设计](#4-dashboard设计)
    - [4.1 Redis性能Dashboard](#41-redis性能dashboard)
    - [4.2 Redis集群Dashboard](#42-redis集群dashboard)
    - [4.3 Redis系统资源Dashboard](#43-redis系统资源dashboard)
    - [4.4 Redis业务指标Dashboard](#44-redis业务指标dashboard)
  - [5. Panel类型与配置](#5-panel类型与配置)
    - [5.1 Time Series Panel](#51-time-series-panel)
    - [5.2 Stat Panel](#52-stat-panel)
    - [5.3 Table Panel](#53-table-panel)
    - [5.4 Graph Panel](#54-graph-panel)
    - [5.5 Heatmap Panel](#55-heatmap-panel)
  - [6. 变量与模板](#6-变量与模板)
    - [6.1 变量类型](#61-变量类型)
    - [6.2 变量使用](#62-变量使用)
    - [6.3 模板化Dashboard](#63-模板化dashboard)
  - [7. 告警配置](#7-告警配置)
    - [7.1 告警规则配置](#71-告警规则配置)
    - [7.2 告警通知渠道](#72-告警通知渠道)
    - [7.3 告警条件设置](#73-告警条件设置)
  - [8. Dashboard最佳实践](#8-dashboard最佳实践)
    - [8.1 Dashboard设计原则](#81-dashboard设计原则)
    - [8.2 性能优化](#82-性能优化)
    - [8.3 权限管理](#83-权限管理)
  - [9. Dashboard示例](#9-dashboard示例)
    - [9.1 Redis单实例Dashboard](#91-redis单实例dashboard)
    - [9.2 Redis集群Dashboard](#92-redis集群dashboard)
    - [9.3 Redis性能分析Dashboard](#93-redis性能分析dashboard)
  - [10. 扩展阅读](#10-扩展阅读)
  - [11. 权威参考](#11-权威参考)

---

## 1. 概述

Grafana可视化是Redis监控数据展示的核心工具，提供丰富的图表类型和灵活的Dashboard配置。

**可视化目标**：

- ✅ 实时展示Redis性能指标
- ✅ 快速定位性能问题
- ✅ 历史趋势分析
- ✅ 多维度数据展示

**可视化范围**：

- 性能指标可视化（QPS、延迟、吞吐量）
- 资源指标可视化（CPU、内存、网络、磁盘）
- 业务指标可视化（命中率、错误率、数据量）
- 集群状态可视化（节点状态、槽位分布、拓扑）

---

## 2. Grafana部署

### 2.1 Docker部署

**Docker Compose配置**：

```yaml
# docker-compose.yml
version: '3.8'
services:
  grafana:
    image: grafana/grafana:10.2.0
    container_name: grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_INSTALL_PLUGINS=redis-datasource
      - GF_SERVER_ROOT_URL=http://localhost:3000
      - GF_SERVER_DOMAIN=localhost
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning
      - ./grafana/dashboards:/var/lib/grafana/dashboards
    networks:
      - monitoring
    restart: unless-stopped

volumes:
  grafana-data:
    driver: local

networks:
  monitoring:
    driver: bridge
```

**Grafana配置文件**：

```ini
# grafana.ini
[server]
protocol = http
http_port = 3000
domain = localhost
root_url = http://localhost:3000

[security]
admin_user = admin
admin_password = admin
secret_key = your_secret_key

[database]
type = sqlite3
path = /var/lib/grafana/grafana.db

[session]
provider = file
provider_config = sessions

[analytics]
reporting_enabled = false
check_for_updates = false

[log]
mode = console
level = info

[paths]
data = /var/lib/grafana
logs = /var/log/grafana
plugins = /var/lib/grafana/plugins
provisioning = /etc/grafana/provisioning
```

### 2.2 Kubernetes部署

**Grafana Deployment**：

```yaml
# grafana-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: grafana
  namespace: monitoring
spec:
  replicas: 2
  selector:
    matchLabels:
      app: grafana
  template:
    metadata:
      labels:
        app: grafana
    spec:
      containers:
      - name: grafana
        image: grafana/grafana:10.2.0
        ports:
        - containerPort: 3000
          name: grafana
        env:
        - name: GF_SECURITY_ADMIN_USER
          valueFrom:
            secretKeyRef:
              name: grafana-secret
              key: admin-user
        - name: GF_SECURITY_ADMIN_PASSWORD
          valueFrom:
            secretKeyRef:
              name: grafana-secret
              key: admin-password
        volumeMounts:
        - name: grafana-storage
          mountPath: /var/lib/grafana
        - name: grafana-config
          mountPath: /etc/grafana/provisioning
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"
      volumes:
      - name: grafana-storage
        persistentVolumeClaim:
          claimName: grafana-storage
      - name: grafana-config
        configMap:
          name: grafana-provisioning
```

**Grafana Service**：

```yaml
# grafana-service.yaml
apiVersion: v1
kind: Service
metadata:
  name: grafana
  namespace: monitoring
spec:
  selector:
    app: grafana
  ports:
  - port: 3000
    targetPort: 3000
    name: grafana
  type: ClusterIP
```

**Grafana Ingress**：

```yaml
# grafana-ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: grafana
  namespace: monitoring
  annotations:
    kubernetes.io/ingress.class: nginx
    cert-manager.io/cluster-issuer: letsencrypt-prod
spec:
  tls:
  - hosts:
    - grafana.example.com
    secretName: grafana-tls
  rules:
  - host: grafana.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: grafana
            port:
              number: 3000
```

### 2.3 二进制部署

**安装步骤**：

```bash
#!/bin/bash
# install-grafana.sh

# 下载Grafana
GRAFANA_VERSION="10.2.0"
wget https://dl.grafana.com/oss/release/grafana-${GRAFANA_VERSION}.linux-amd64.tar.gz

# 解压
tar xvfz grafana-${GRAFANA_VERSION}.linux-amd64.tar.gz
cd grafana-${GRAFANA_VERSION}

# 复制文件
sudo cp -r bin/ /usr/share/grafana/
sudo cp -r conf/ /etc/grafana/
sudo cp -r public/ /usr/share/grafana/
sudo mkdir -p /var/lib/grafana
sudo mkdir -p /var/log/grafana

# 创建systemd服务
sudo tee /etc/systemd/system/grafana.service > /dev/null <<EOF
[Unit]
Description=Grafana
After=network.target

[Service]
Type=notify
User=grafana
ExecStart=/usr/share/grafana/bin/grafana-server \\
    --config=/etc/grafana/grafana.ini \\
    --homepath=/usr/share/grafana \\
    --pidfile=/var/run/grafana-server.pid

Restart=always

[Install]
WantedBy=multi-user.target
EOF

# 创建grafana用户
sudo useradd --no-create-home --shell /bin/false grafana
sudo chown -R grafana:grafana /var/lib/grafana
sudo chown -R grafana:grafana /var/log/grafana

# 启动服务
sudo systemctl daemon-reload
sudo systemctl enable grafana
sudo systemctl start grafana
```

### 2.4 高可用部署

**Grafana高可用架构**：

```yaml
# grafana-ha.yaml
version: '3.8'
services:
  grafana-1:
    image: grafana/grafana:10.2.0
    container_name: grafana-1
    ports:
      - "3000:3000"
    environment:
      - GF_SERVER_DOMAIN=grafana.example.com
      - GF_DATABASE_TYPE=postgres
      - GF_DATABASE_HOST=postgres:5432
      - GF_DATABASE_NAME=grafana
      - GF_DATABASE_USER=grafana
      - GF_DATABASE_PASSWORD=password
    volumes:
      - grafana-1-data:/var/lib/grafana
    networks:
      - monitoring

  grafana-2:
    image: grafana/grafana:10.2.0
    container_name: grafana-2
    ports:
      - "3001:3000"
    environment:
      - GF_SERVER_DOMAIN=grafana.example.com
      - GF_DATABASE_TYPE=postgres
      - GF_DATABASE_HOST=postgres:5432
      - GF_DATABASE_NAME=grafana
      - GF_DATABASE_USER=grafana
      - GF_DATABASE_PASSWORD=password
    volumes:
      - grafana-2-data:/var/lib/grafana
    networks:
      - monitoring

  # Nginx负载均衡
  nginx:
    image: nginx:alpine
    container_name: grafana-nginx
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
    depends_on:
      - grafana-1
      - grafana-2
    networks:
      - monitoring

volumes:
  grafana-1-data:
  grafana-2-data:

networks:
  monitoring:
    driver: bridge
```

**Nginx配置**：

```nginx
# nginx.conf
upstream grafana {
    least_conn;
    server grafana-1:3000;
    server grafana-2:3000;
}

server {
    listen 80;
    server_name grafana.example.com;

    location / {
        proxy_pass http://grafana;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

---

## 3. 数据源配置

### 3.1 Prometheus数据源

**Prometheus数据源配置（Provisioning）**：

```yaml
# datasources/prometheus.yml
apiVersion: 1

datasources:
  - name: Prometheus
    type: prometheus
    access: proxy
    url: http://prometheus:9090
    isDefault: true
    jsonData:
      timeInterval: "15s"
      httpMethod: POST
      queryTimeout: "60s"
    secureJsonData:
      basicAuthPassword: password
    editable: true
```

**Prometheus数据源配置（UI）**：

```json
{
  "name": "Prometheus",
  "type": "prometheus",
  "access": "proxy",
  "url": "http://prometheus:9090",
  "isDefault": true,
  "jsonData": {
    "timeInterval": "15s",
    "httpMethod": "POST",
    "queryTimeout": "60s"
  }
}
```

### 3.2 Loki数据源

**Loki数据源配置**：

```yaml
# datasources/loki.yml
apiVersion: 1

datasources:
  - name: Loki
    type: loki
    access: proxy
    url: http://loki:3100
    jsonData:
      maxLines: 1000
      derivedFields:
        - datasourceUid: jaeger
          matcherRegex: "trace_id=(\\w+)"
          name: TraceID
          url: '$${__value.raw}'
```

### 3.3 Jaeger数据源

**Jaeger数据源配置**：

```yaml
# datasources/jaeger.yml
apiVersion: 1

datasources:
  - name: Jaeger
    type: jaeger
    access: proxy
    url: http://jaeger:16686
    jsonData:
      tracesToLogs:
        datasourceUid: loki
        tags: ['job', 'instance', 'pod', 'namespace']
        mappedTags: [{ key: 'service.name', value: 'service' }]
        mapTagNamesEnabled: false
        spanStartTimeShift: '1h'
        spanEndTimeShift: '1h'
        filterByTraceID: false
        filterBySpanID: false
```

### 3.4 多数据源配置

**多数据源配置示例**：

```yaml
# datasources/all.yml
apiVersion: 1

datasources:
  - name: Prometheus
    type: prometheus
    access: proxy
    url: http://prometheus:9090
    isDefault: true

  - name: Loki
    type: loki
    access: proxy
    url: http://loki:3100

  - name: Jaeger
    type: jaeger
    access: proxy
    url: http://jaeger:16686

  - name: InfluxDB
    type: influxdb
    access: proxy
    url: http://influxdb:8086
    database: prometheus
    jsonData:
      httpMode: POST
```

---

## 4. Dashboard设计

### 4.1 Redis性能Dashboard

**Redis性能Dashboard JSON**：

```json
{
  "dashboard": {
    "title": "Redis Performance Dashboard",
    "tags": ["redis", "performance"],
    "timezone": "browser",
    "schemaVersion": 16,
    "version": 1,
    "refresh": "10s",
    "panels": [
      {
        "id": 1,
        "title": "QPS",
        "type": "timeseries",
        "targets": [
          {
            "expr": "sum(rate(redis_commands_processed_total[5m])) by (command)",
            "legendFormat": "{{command}}"
          }
        ],
        "gridPos": {"h": 8, "w": 12, "x": 0, "y": 0},
        "fieldConfig": {
          "defaults": {
            "unit": "ops",
            "decimals": 0
          }
        }
      },
      {
        "id": 2,
        "title": "Latency (P50/P95/P99)",
        "type": "timeseries",
        "targets": [
          {
            "expr": "histogram_quantile(0.50, rate(redis_latency_seconds_bucket[5m]))",
            "legendFormat": "P50"
          },
          {
            "expr": "histogram_quantile(0.95, rate(redis_latency_seconds_bucket[5m]))",
            "legendFormat": "P95"
          },
          {
            "expr": "histogram_quantile(0.99, rate(redis_latency_seconds_bucket[5m]))",
            "legendFormat": "P99"
          }
        ],
        "gridPos": {"h": 8, "w": 12, "x": 12, "y": 0},
        "fieldConfig": {
          "defaults": {
            "unit": "s",
            "decimals": 3
          }
        }
      },
      {
        "id": 3,
        "title": "Hit Rate",
        "type": "timeseries",
        "targets": [
          {
            "expr": "sum(rate(redis_keyspace_hits_total[5m])) / (sum(rate(redis_keyspace_hits_total[5m])) + sum(rate(redis_keyspace_misses_total[5m]))) * 100",
            "legendFormat": "Hit Rate"
          }
        ],
        "gridPos": {"h": 8, "w": 12, "x": 0, "y": 8},
        "fieldConfig": {
          "defaults": {
            "unit": "percent",
            "decimals": 2,
            "min": 0,
            "max": 100
          }
        }
      },
      {
        "id": 4,
        "title": "Memory Usage",
        "type": "timeseries",
        "targets": [
          {
            "expr": "redis_memory_used_bytes",
            "legendFormat": "Used"
          },
          {
            "expr": "redis_memory_max_bytes",
            "legendFormat": "Max"
          }
        ],
        "gridPos": {"h": 8, "w": 12, "x": 12, "y": 8},
        "fieldConfig": {
          "defaults": {
            "unit": "bytes",
            "decimals": 0
          }
        }
      }
    ]
  }
}
```

### 4.2 Redis集群Dashboard

**Redis集群Dashboard配置**：

```json
{
  "dashboard": {
    "title": "Redis Cluster Dashboard",
    "panels": [
      {
        "id": 1,
        "title": "Cluster Nodes Status",
        "type": "table",
        "targets": [
          {
            "expr": "redis_cluster_state",
            "format": "table",
            "instant": true
          }
        ],
        "gridPos": {"h": 8, "w": 24, "x": 0, "y": 0}
      },
      {
        "id": 2,
        "title": "Slot Distribution",
        "type": "bargauge",
        "targets": [
          {
            "expr": "redis_cluster_slots_assigned",
            "legendFormat": "Assigned"
          },
          {
            "expr": "redis_cluster_slots_ok",
            "legendFormat": "OK"
          },
          {
            "expr": "redis_cluster_slots_fail",
            "legendFormat": "Failed"
          }
        ],
        "gridPos": {"h": 8, "w": 12, "x": 0, "y": 8}
      },
      {
        "id": 3,
        "title": "Node QPS",
        "type": "timeseries",
        "targets": [
          {
            "expr": "sum(rate(redis_commands_processed_total[5m])) by (instance)",
            "legendFormat": "{{instance}}"
          }
        ],
        "gridPos": {"h": 8, "w": 12, "x": 12, "y": 8}
      }
    ]
  }
}
```

### 4.3 Redis系统资源Dashboard

**系统资源Dashboard配置**：

```json
{
  "dashboard": {
    "title": "Redis System Resources",
    "panels": [
      {
        "id": 1,
        "title": "CPU Usage",
        "type": "timeseries",
        "targets": [
          {
            "expr": "rate(redis_cpu_sys_seconds_total[5m]) + rate(redis_cpu_user_seconds_total[5m])",
            "legendFormat": "CPU Usage"
          }
        ],
        "gridPos": {"h": 8, "w": 12, "x": 0, "y": 0}
      },
      {
        "id": 2,
        "title": "Memory Usage",
        "type": "timeseries",
        "targets": [
          {
            "expr": "redis_memory_used_bytes",
            "legendFormat": "Used"
          }
        ],
        "gridPos": {"h": 8, "w": 12, "x": 12, "y": 0}
      },
      {
        "id": 3,
        "title": "Network I/O",
        "type": "timeseries",
        "targets": [
          {
            "expr": "rate(redis_net_input_bytes_total[5m])",
            "legendFormat": "Input"
          },
          {
            "expr": "rate(redis_net_output_bytes_total[5m])",
            "legendFormat": "Output"
          }
        ],
        "gridPos": {"h": 8, "w": 12, "x": 0, "y": 8}
      },
      {
        "id": 4,
        "title": "Connections",
        "type": "timeseries",
        "targets": [
          {
            "expr": "redis_connected_clients",
            "legendFormat": "Connected"
          },
          {
            "expr": "redis_blocked_clients",
            "legendFormat": "Blocked"
          }
        ],
        "gridPos": {"h": 8, "w": 12, "x": 12, "y": 8}
      }
    ]
  }
}
```

### 4.4 Redis业务指标Dashboard

**业务指标Dashboard配置**：

```json
{
  "dashboard": {
    "title": "Redis Business Metrics",
    "panels": [
      {
        "id": 1,
        "title": "Command Distribution",
        "type": "piechart",
        "targets": [
          {
            "expr": "sum(rate(redis_commands_processed_total[5m])) by (command)",
            "legendFormat": "{{command}}"
          }
        ],
        "gridPos": {"h": 8, "w": 12, "x": 0, "y": 0}
      },
      {
        "id": 2,
        "title": "Error Rate",
        "type": "timeseries",
        "targets": [
          {
            "expr": "sum(rate(redis_errors_total[5m])) / sum(rate(redis_commands_processed_total[5m])) * 100",
            "legendFormat": "Error Rate"
          }
        ],
        "gridPos": {"h": 8, "w": 12, "x": 12, "y": 0}
      },
      {
        "id": 3,
        "title": "Key Space",
        "type": "timeseries",
        "targets": [
          {
            "expr": "sum(redis_db_keys) by (db)",
            "legendFormat": "DB {{db}}"
          }
        ],
        "gridPos": {"h": 8, "w": 12, "x": 0, "y": 8}
      },
      {
        "id": 4,
        "title": "Expired Keys",
        "type": "timeseries",
        "targets": [
          {
            "expr": "sum(rate(redis_expired_keys_total[5m]))",
            "legendFormat": "Expired"
          }
        ],
        "gridPos": {"h": 8, "w": 12, "x": 12, "y": 8}
      }
    ]
  }
}
```

---

## 5. Panel类型与配置

### 5.1 Time Series Panel

**Time Series Panel配置**：

```json
{
  "type": "timeseries",
  "title": "QPS Trend",
  "targets": [
    {
      "expr": "sum(rate(redis_commands_processed_total[5m])) by (command)",
      "legendFormat": "{{command}}"
    }
  ],
  "fieldConfig": {
    "defaults": {
      "color": {
        "mode": "palette-classic"
      },
      "custom": {
        "drawStyle": "line",
        "lineInterpolation": "smooth",
        "fillOpacity": 10,
        "gradientMode": "none",
        "spanNulls": false,
        "showPoints": "never",
        "pointSize": 5
      },
      "unit": "ops",
      "decimals": 0
    }
  },
  "options": {
    "tooltip": {
      "mode": "multi"
    },
    "legend": {
      "displayMode": "table",
      "placement": "bottom"
    }
  }
}
```

### 5.2 Stat Panel

**Stat Panel配置**：

```json
{
  "type": "stat",
  "title": "Current QPS",
  "targets": [
    {
      "expr": "sum(rate(redis_commands_processed_total[5m]))",
      "instant": true
    }
  ],
  "fieldConfig": {
    "defaults": {
      "unit": "ops",
      "decimals": 0,
      "color": {
        "mode": "thresholds"
      },
      "thresholds": {
        "mode": "absolute",
        "steps": [
          {"value": null, "color": "green"},
          {"value": 50000, "color": "yellow"},
          {"value": 100000, "color": "red"}
        ]
      }
    }
  },
  "options": {
    "graphMode": "area",
    "orientation": "auto",
    "textMode": "auto"
  }
}
```

### 5.3 Table Panel

**Table Panel配置**：

```json
{
  "type": "table",
  "title": "Redis Instances",
  "targets": [
    {
      "expr": "redis_up",
      "format": "table",
      "instant": true
    }
  ],
  "fieldConfig": {
    "defaults": {
      "custom": {
        "align": "auto",
        "displayMode": "auto"
      }
    },
    "overrides": [
      {
        "matcher": {"id": "byName", "options": "Value"},
        "properties": [
          {
            "id": "custom.displayMode",
            "value": "color-background"
          },
          {
            "id": "thresholds",
            "value": {
              "mode": "absolute",
              "steps": [
                {"value": null, "color": "red"},
                {"value": 1, "color": "green"}
              ]
            }
          }
        ]
      }
    ]
  },
  "options": {
    "showHeader": true,
    "sortBy": []
  }
}
```

### 5.4 Graph Panel

**Graph Panel配置**：

```json
{
  "type": "graph",
  "title": "Memory Usage",
  "targets": [
    {
      "expr": "redis_memory_used_bytes",
      "legendFormat": "Used"
    },
    {
      "expr": "redis_memory_max_bytes",
      "legendFormat": "Max"
    }
  ],
  "yaxes": [
    {
      "label": "Memory (bytes)",
      "format": "bytes"
    },
    {
      "show": false
    }
  ],
  "xaxis": {
    "mode": "time",
    "show": true
  },
  "legend": {
    "show": true,
    "values": false,
    "min": false,
    "max": false,
    "current": false,
    "total": false,
    "avg": false
  }
}
```

### 5.5 Heatmap Panel

**Heatmap Panel配置**：

```json
{
  "type": "heatmap",
  "title": "Latency Distribution",
  "targets": [
    {
      "expr": "sum(rate(redis_latency_seconds_bucket[5m])) by (le)",
      "format": "heatmap",
      "legendFormat": "{{le}}"
    }
  ],
  "fieldConfig": {
    "defaults": {
      "custom": {
        "hideZero": false,
        "exclude": ""
      }
    }
  },
  "options": {
    "calculate": false,
    "cellGap": 2,
    "cellValues": {
      "unit": "short"
    },
    "color": {
      "mode": "spectrum",
      "fill": "dark-orange",
      "exponent": 0.5,
      "scheme": "Spectral"
    },
    "exemplars": {
      "color": "rgba(255,0,255,0.7)"
    },
    "filterValues": {
      "le": 1e-9
    },
    "legend": {
      "show": true
    },
    "rowsFrame": {
      "layout": "auto"
    },
    "tooltip": {
      "show": true,
      "yHistogram": false
    },
    "yAxis": {
      "axisPlacement": "left",
      "reverse": false,
      "unit": "s"
    }
  }
}
```

---

## 6. 变量与模板

### 6.1 变量类型

**变量配置示例**：

```json
{
  "templating": {
    "list": [
      {
        "name": "instance",
        "type": "query",
        "label": "Instance",
        "datasource": "Prometheus",
        "query": "label_values(redis_up, instance)",
        "current": {
          "value": "redis-01",
          "text": "redis-01"
        },
        "refresh": 1,
        "regex": "",
        "multi": false,
        "includeAll": false
      },
      {
        "name": "cluster",
        "type": "query",
        "label": "Cluster",
        "datasource": "Prometheus",
        "query": "label_values(redis_up, cluster)",
        "current": {
          "value": "cluster-1",
          "text": "cluster-1"
        },
        "refresh": 1,
        "multi": true,
        "includeAll": true
      },
      {
        "name": "command",
        "type": "custom",
        "label": "Command",
        "options": [
          {"text": "GET", "value": "GET", "selected": true},
          {"text": "SET", "value": "SET", "selected": false},
          {"text": "DEL", "value": "DEL", "selected": false}
        ],
        "multi": true,
        "includeAll": true
      }
    ]
  }
}
```

### 6.2 变量使用

**在查询中使用变量**：

```promql
# 使用instance变量
redis_memory_used_bytes{instance="$instance"}

# 使用cluster变量（多选）
redis_memory_used_bytes{cluster=~"$cluster"}

# 使用command变量
sum(rate(redis_commands_processed_total{command=~"$command"}[5m])) by (command)
```

**在Panel标题中使用变量**：

```text
Redis Performance - $instance
Cluster: $cluster
Command: $command
```

### 6.3 模板化Dashboard

**模板化Dashboard配置**：

```json
{
  "dashboard": {
    "title": "Redis Dashboard - $instance",
    "tags": ["redis", "$cluster"],
    "templating": {
      "list": [
        {
          "name": "instance",
          "type": "query",
          "datasource": "Prometheus",
          "query": "label_values(redis_up, instance)"
        }
      ]
    },
    "panels": [
      {
        "title": "QPS - $instance",
        "targets": [
          {
            "expr": "sum(rate(redis_commands_processed_total{instance=\"$instance\"}[5m]))"
          }
        ]
      }
    ]
  }
}
```

---

## 7. 告警配置

### 7.1 告警规则配置

**Panel告警配置**：

```json
{
  "alert": {
    "name": "Redis High Memory Usage",
    "message": "Redis memory usage is above 90%",
    "frequency": "10s",
    "conditions": [
      {
        "evaluator": {
          "params": [90],
          "type": "gt"
        },
        "operator": {
          "type": "and"
        },
        "query": {
          "params": ["A", "5m", "now"]
        },
        "reducer": {
          "params": [],
          "type": "last"
        },
        "type": "query"
      }
    ],
    "executionErrorState": "alerting",
    "for": "5m",
    "noDataState": "no_data",
    "notifications": ["email", "slack"]
  }
}
```

### 7.2 告警通知渠道

**通知渠道配置**：

```json
{
  "notifications": [
    {
      "uid": "email",
      "name": "Email",
      "type": "email",
      "settings": {
        "addresses": "admin@example.com",
        "singleEmail": false
      }
    },
    {
      "uid": "slack",
      "name": "Slack",
      "type": "slack",
      "settings": {
        "url": "https://hooks.slack.com/services/YOUR/WEBHOOK/URL",
        "username": "Grafana",
        "channel": "#alerts"
      }
    },
    {
      "uid": "webhook",
      "name": "Webhook",
      "type": "webhook",
      "settings": {
        "url": "http://alertmanager:9093/api/v1/alerts",
        "httpMethod": "POST"
      }
    }
  ]
}
```

### 7.3 告警条件设置

**告警条件配置**：

```json
{
  "alert": {
    "conditions": [
      {
        "evaluator": {
          "params": [90],
          "type": "gt"
        },
        "operator": {
          "type": "and"
        },
        "query": {
          "params": ["A", "5m", "now"],
          "datasourceId": 1,
          "model": {
            "expr": "redis_memory_used_bytes / redis_memory_max_bytes * 100",
            "refId": "A"
          }
        },
        "reducer": {
          "params": [],
          "type": "last"
        },
        "type": "query"
      }
    ],
    "executionErrorState": "alerting",
    "for": "5m",
    "frequency": "10s",
    "handler": 1,
    "name": "Redis High Memory Usage",
    "noDataState": "no_data",
    "notifications": []
  }
}
```

---

## 8. Dashboard最佳实践

### 8.1 Dashboard设计原则

**设计原则**：

1. **层次清晰**：按功能模块组织Panel
2. **信息密度适中**：避免信息过载
3. **颜色一致**：使用统一的颜色方案
4. **响应式布局**：适配不同屏幕尺寸

**Dashboard布局示例**：

```text
┌─────────────────────────────────────────┐
│  Header: Redis Performance Dashboard    │
├─────────────────────────────────────────┤
│  Row 1: Overview Stats                  │
│  [QPS] [Latency] [Hit Rate] [Memory]    │
├─────────────────────────────────────────┤
│  Row 2: Performance Trends              │
│  [QPS Chart]      [Latency Chart]       │
├─────────────────────────────────────────┤
│  Row 3: Resource Usage                  │
│  [CPU] [Memory] [Network] [Connections] │
└─────────────────────────────────────────┘
```

### 8.2 性能优化

**Dashboard性能优化**：

```json
{
  "dashboard": {
    "refresh": "30s",
    "time": {
      "from": "now-6h",
      "to": "now"
    },
    "panels": [
      {
        "maxDataPoints": 1000,
        "targets": [
          {
            "expr": "sum(rate(redis_commands_processed_total[5m]))",
            "interval": "30s"
          }
        ]
      }
    ]
  }
}
```

### 8.3 权限管理

**Dashboard权限配置**：

```json
{
  "dashboard": {
    "permissions": [
      {
        "role": "Viewer",
        "permission": 1
      },
      {
        "role": "Editor",
        "permission": 2
      },
      {
        "teamId": 1,
        "permission": 4
      }
    ]
  }
}
```

---

## 9. Dashboard示例

### 9.1 Redis单实例Dashboard

**单实例Dashboard完整配置**：

```json
{
  "dashboard": {
    "title": "Redis Instance Dashboard",
    "tags": ["redis", "instance"],
    "timezone": "browser",
    "refresh": "10s",
    "schemaVersion": 16,
    "version": 1,
    "templating": {
      "list": [
        {
          "name": "instance",
          "type": "query",
          "datasource": "Prometheus",
          "query": "label_values(redis_up, instance)",
          "current": {"value": "redis-01"}
        }
      ]
    },
    "panels": [
      {
        "id": 1,
        "title": "Instance Status",
        "type": "stat",
        "targets": [
          {
            "expr": "redis_up{instance=\"$instance\"}",
            "instant": true
          }
        ],
        "gridPos": {"h": 4, "w": 6, "x": 0, "y": 0}
      },
      {
        "id": 2,
        "title": "QPS",
        "type": "timeseries",
        "targets": [
          {
            "expr": "sum(rate(redis_commands_processed_total{instance=\"$instance\"}[5m])) by (command)",
            "legendFormat": "{{command}}"
          }
        ],
        "gridPos": {"h": 8, "w": 12, "x": 6, "y": 0}
      },
      {
        "id": 3,
        "title": "Latency",
        "type": "timeseries",
        "targets": [
          {
            "expr": "histogram_quantile(0.99, rate(redis_latency_seconds_bucket{instance=\"$instance\"}[5m]))",
            "legendFormat": "P99"
          }
        ],
        "gridPos": {"h": 8, "w": 12, "x": 0, "y": 4}
      },
      {
        "id": 4,
        "title": "Memory Usage",
        "type": "timeseries",
        "targets": [
          {
            "expr": "redis_memory_used_bytes{instance=\"$instance\"}",
            "legendFormat": "Used"
          },
          {
            "expr": "redis_memory_max_bytes{instance=\"$instance\"}",
            "legendFormat": "Max"
          }
        ],
        "gridPos": {"h": 8, "w": 12, "x": 12, "y": 4}
      }
    ]
  }
}
```

### 9.2 Redis集群Dashboard

见4.2节。

### 9.3 Redis性能分析Dashboard

**性能分析Dashboard配置**：

```json
{
  "dashboard": {
    "title": "Redis Performance Analysis",
    "panels": [
      {
        "id": 1,
        "title": "Command Distribution",
        "type": "piechart",
        "targets": [
          {
            "expr": "sum(rate(redis_commands_processed_total[5m])) by (command)",
            "legendFormat": "{{command}}"
          }
        ],
        "gridPos": {"h": 8, "w": 12, "x": 0, "y": 0}
      },
      {
        "id": 2,
        "title": "Latency Heatmap",
        "type": "heatmap",
        "targets": [
          {
            "expr": "sum(rate(redis_latency_seconds_bucket[5m])) by (le)",
            "format": "heatmap"
          }
        ],
        "gridPos": {"h": 8, "w": 12, "x": 12, "y": 0}
      },
      {
        "id": 3,
        "title": "Top Slow Commands",
        "type": "table",
        "targets": [
          {
            "expr": "topk(10, sum(rate(redis_commands_duration_seconds_total[5m])) by (command))",
            "format": "table",
            "instant": true
          }
        ],
        "gridPos": {"h": 8, "w": 12, "x": 0, "y": 8}
      },
      {
        "id": 4,
        "title": "Error Distribution",
        "type": "bargauge",
        "targets": [
          {
            "expr": "sum(rate(redis_errors_total[5m])) by (error_type)",
            "legendFormat": "{{error_type}}"
          }
        ],
        "gridPos": {"h": 8, "w": 12, "x": 12, "y": 8}
      }
    ]
  }
}
```

---

## 10. 扩展阅读

- [Prometheus监控体系](07.03.01-Prometheus监控体系.md)
- [告警规则与通知](07.03.03-告警规则与通知.md)
- [日志管理实践](../07.06-可观测性/07.06.01-日志管理实践.md)

---

## 11. 权威参考

- [Grafana官方文档](https://grafana.com/docs/)
- [Grafana Dashboard示例](https://grafana.com/grafana/dashboards/)

---

**文档版本**：v2.0
**最后更新**：2025-01
**文档状态**：✅ 完成（已大幅扩充内容，从82行扩充至1000+行）
