# 07.05.01 集群部署实践

## 目录

- [07.05.01 集群部署实践](#070501-集群部署实践)
  - [目录](#目录)
  - [1. 概述](#1-概述)
    - [1.1 定义与背景](#11-定义与背景)
  - [2. 大规模集群部署](#2-大规模集群部署)
    - [2.1 100+节点集群规划](#21-100节点集群规划)
    - [2.2 部署脚本](#22-部署脚本)
  - [3. 集群初始化](#3-集群初始化)
    - [3.1 初始化流程](#31-初始化流程)
    - [3.2 初始化脚本](#32-初始化脚本)
  - [4. 集群扩容](#4-集群扩容)
    - [4.1 扩容流程](#41-扩容流程)
    - [4.2 扩容脚本](#42-扩容脚本)
  - [5. 集群缩容](#5-集群缩容)
    - [5.1 缩容流程](#51-缩容流程)
    - [5.2 缩容脚本](#52-缩容脚本)
  - [6. 多地域部署](#6-多地域部署)
    - [6.1 地域规划](#61-地域规划)
    - [6.2 跨地域复制](#62-跨地域复制)
  - [7. 跨云部署](#7-跨云部署)
    - [7.1 多云架构](#71-多云架构)
    - [7.2 跨云同步](#72-跨云同步)
  - [8. 部署验证](#8-部署验证)
    - [8.1 集群状态检查](#81-集群状态检查)
    - [8.2 性能测试](#82-性能测试)
  - [9. 扩展阅读](#9-扩展阅读)
  - [10. 权威参考](#10-权威参考)

---

## 1. 概述

### 1.1 定义与背景

**集群部署实践**涵盖Redis集群的大规模部署、初始化、扩容、缩容等核心操作。

**部署目标**：

- ✅ 100+节点集群部署
- ✅ 多地域集群部署
- ✅ 跨云集群部署
- ✅ 自动化部署流程

---

## 2. 大规模集群部署

### 2.1 100+节点集群规划

**节点规划**：

- 主节点：50个
- 从节点：50个
- 总槽位：16384个
- 每个主节点：约328个槽位

**网络规划**：

- 每个节点独立IP
- 节点间网络延迟<1ms
- 带宽：10Gbps+

### 2.2 部署脚本

```bash
#!/bin/bash
# deploy-cluster.sh

NODES=100
REPLICAS=1
START_PORT=7000

# 创建节点配置
for i in $(seq 0 $((NODES-1))); do
    port=$((START_PORT + i))
    mkdir -p cluster-node-$i
    cat > cluster-node-$i/redis.conf <<EOF
port $port
cluster-enabled yes
cluster-config-file nodes-$port.conf
cluster-node-timeout 5000
appendonly yes
dir /data/redis/cluster-node-$i
EOF
done

# 启动所有节点
for i in $(seq 0 $((NODES-1))); do
    port=$((START_PORT + i))
    redis-server cluster-node-$i/redis.conf &
done

# 等待节点启动
sleep 5

# 创建集群
redis-cli --cluster create \
    $(for i in $(seq 0 $((NODES-1))); do
        echo -n "127.0.0.1:$((START_PORT + i)) "
    done) \
    --cluster-replicas $REPLICAS
```

---

## 3. 集群初始化

### 3.1 初始化流程

1. **节点准备**：创建节点配置和目录
2. **节点启动**：启动所有Redis节点
3. **集群创建**：执行`redis-cli --cluster create`
4. **槽位分配**：自动分配16384个槽位
5. **验证集群**：检查集群状态

### 3.2 初始化脚本

```python
#!/usr/bin/env python3
# cluster-init.py

import subprocess
import time

def init_cluster(nodes, replicas=1, start_port=7000):
    """初始化Redis集群"""

    # 1. 创建节点配置
    for i in range(nodes):
        port = start_port + i
        create_node_config(i, port)

    # 2. 启动所有节点
    for i in range(nodes):
        port = start_port + i
        start_node(i, port)

    # 3. 等待节点启动
    time.sleep(5)

    # 4. 创建集群
    create_cluster(nodes, replicas, start_port)

    # 5. 验证集群
    verify_cluster(start_port)

def create_node_config(node_id, port):
    """创建节点配置"""
    config = f"""
port {port}
cluster-enabled yes
cluster-config-file nodes-{port}.conf
cluster-node-timeout 5000
appendonly yes
dir /data/redis/cluster-node-{node_id}
"""
    with open(f"cluster-node-{node_id}/redis.conf", "w") as f:
        f.write(config)

def start_node(node_id, port):
    """启动节点"""
    subprocess.Popen([
        "redis-server",
        f"cluster-node-{node_id}/redis.conf"
    ])

def create_cluster(nodes, replicas, start_port):
    """创建集群"""
    nodes_str = " ".join([
        f"127.0.0.1:{start_port + i}"
        for i in range(nodes)
    ])

    subprocess.run([
        "redis-cli", "--cluster", "create",
        *nodes_str.split(),
        "--cluster-replicas", str(replicas),
        "--cluster-yes"
    ])

def verify_cluster(start_port):
    """验证集群"""
    result = subprocess.run([
        "redis-cli", "-p", str(start_port),
        "CLUSTER", "INFO"
    ], capture_output=True, text=True)

    print(result.stdout)
```

---

## 4. 集群扩容

### 4.1 扩容流程

1. **添加新节点**：启动新的Redis节点
2. **加入集群**：执行`CLUSTER MEET`
3. **迁移槽位**：从现有节点迁移槽位到新节点
4. **添加从节点**：为新区节点添加从节点
5. **验证扩容**：检查集群状态

### 4.2 扩容脚本

```bash
#!/bin/bash
# cluster-scale-out.sh

NEW_NODE_IP="192.168.1.100"
NEW_NODE_PORT=7000
EXISTING_NODE_IP="192.168.1.10"
EXISTING_NODE_PORT=7000
SLOTS_TO_MIGRATE=328

# 1. 启动新节点
redis-server --port $NEW_NODE_PORT --cluster-enabled yes &

# 2. 加入集群
redis-cli -h $EXISTING_NODE_IP -p $EXISTING_NODE_PORT \
    CLUSTER MEET $NEW_NODE_IP $NEW_NODE_PORT

# 3. 迁移槽位
redis-cli --cluster reshard \
    $EXISTING_NODE_IP:$EXISTING_NODE_PORT \
    --cluster-from <node-id> \
    --cluster-to <new-node-id> \
    --cluster-slots $SLOTS_TO_MIGRATE \
    --cluster-yes

# 4. 添加从节点
redis-cli --cluster add-node \
    $NEW_NODE_IP:$((NEW_NODE_PORT + 1)) \
    $EXISTING_NODE_IP:$EXISTING_NODE_PORT \
    --cluster-slave \
    --cluster-master-id <new-node-id>
```

---

## 5. 集群缩容

### 5.1 缩容流程

1. **迁移槽位**：将待删除节点的槽位迁移到其他节点
2. **删除从节点**：删除从节点
3. **删除主节点**：删除主节点
4. **验证缩容**：检查集群状态

### 5.2 缩容脚本

```bash
#!/bin/bash
# cluster-scale-in.sh

NODE_TO_REMOVE_IP="192.168.1.100"
NODE_TO_REMOVE_PORT=7000
TARGET_NODE_IP="192.168.1.10"
TARGET_NODE_PORT=7000

# 1. 迁移槽位
redis-cli --cluster reshard \
    $TARGET_NODE_IP:$TARGET_NODE_PORT \
    --cluster-from <node-to-remove-id> \
    --cluster-to <target-node-id> \
    --cluster-slots <all-slots> \
    --cluster-yes

# 2. 删除节点
redis-cli --cluster del-node \
    $TARGET_NODE_IP:$TARGET_NODE_PORT \
    <node-to-remove-id>
```

---

## 6. 多地域部署

### 6.1 地域规划

**三地域部署**：

- 地域1：主节点20个，从节点20个
- 地域2：主节点15个，从节点15个
- 地域3：主节点15个，从节点15个

### 6.2 跨地域复制

```bash
# 地域1主节点配置
replicaof <region2-master-ip> 6379

# 地域2主节点配置
replicaof <region1-master-ip> 6379
```

---

## 7. 跨云部署

### 7.1 多云架构

**AWS + 阿里云 + 腾讯云**：

- AWS：主集群
- 阿里云：备份集群
- 腾讯云：灾备集群

### 7.2 跨云同步

使用Redis Replication或第三方工具实现跨云数据同步。

---

## 8. 部署验证

### 8.1 集群状态检查

```bash
# 检查集群状态
redis-cli -p 7000 CLUSTER INFO

# 检查节点信息
redis-cli -p 7000 CLUSTER NODES

# 检查槽位分配
redis-cli -p 7000 CLUSTER SLOTS
```

### 8.2 性能测试

```bash
# 使用redis-benchmark测试
redis-benchmark -h 127.0.0.1 -p 7000 -c 100 -n 100000
```

---

## 9. 扩展阅读

- [集群运维实践](07.05.02-集群运维实践.md)
- [集群故障处理](07.05.03-集群故障处理.md)
- [Redis Cluster集群模式](../../03-Redis组件/03.03-高可用架构/03.03.03-Cluster集群模式.md)

---

## 10. 权威参考

- [Redis Cluster官方文档](https://redis.io/docs/manual/scaling/)
- [Redis Cluster教程](https://redis.io/docs/manual/scaling/)

---

**文档版本**：v1.0
**最后更新**：2025-01
**文档状态**：✅ 完成
