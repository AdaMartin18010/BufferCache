# 08.01.01 Raft协议实践

## 目录

- [08.01.01 Raft协议实践](#080101-raft协议实践)
  - [目录](#目录)
  - [1. 概述](#1-概述)
    - [1.1 定义与背景](#11-定义与背景)
    - [1.2 应用价值](#12-应用价值)
  - [2. Raft协议基础](#2-raft协议基础)
    - [2.1 Raft核心概念](#21-raft核心概念)
    - [2.2 Raft状态机](#22-raft状态机)
  - [3. Redis Raft实现](#3-redis-raft实现)
    - [3.1 Redis Raft配置](#31-redis-raft配置)
    - [3.2 Raft集群部署](#32-raft集群部署)
  - [4. Raft实践案例](#4-raft实践案例)
    - [4.1 主节点选举](#41-主节点选举)
    - [4.2 日志复制](#42-日志复制)
  - [5. 扩展阅读](#5-扩展阅读)
  - [6. 权威参考](#6-权威参考)

---

## 1. 概述

### 1.1 定义与背景

**Raft**是一种分布式一致性算法，用于在分布式系统中实现日志复制和一致性。

**Raft特点**：

- ✅ **易于理解**：相比Paxos更易理解
- ✅ **强一致性**：保证强一致性
- ✅ **高可用**：支持节点故障恢复

### 1.2 应用价值

Raft在Redis中的应用价值：

1. **强一致性**：保证数据强一致性
2. **高可用**：支持节点故障自动恢复
3. **易于运维**：相比Paxos更易运维

---

## 2. Raft协议基础

### 2.1 Raft核心概念

**Raft核心概念**：

- **Leader**：主节点，处理所有客户端请求
- **Follower**：从节点，接收Leader的日志复制
- **Candidate**：候选节点，参与选举

**Raft状态转换**：

```text
Follower → Candidate → Leader
    ↑         ↓
    └─────────┘
```

### 2.2 Raft状态机

**Raft状态机**：

```python
class RaftNode:
    def __init__(self):
        self.state = "Follower"  # Follower, Candidate, Leader
        self.current_term = 0
        self.voted_for = None
        self.log = []

    def become_candidate(self):
        self.state = "Candidate"
        self.current_term += 1
        self.voted_for = self.node_id

    def become_leader(self):
        self.state = "Leader"
        self.next_index = {}
        self.match_index = {}
```

---

## 3. Redis Raft实现

### 3.1 Redis Raft配置

**Redis Raft配置**：

```conf
# redis-raft.conf
port 6379
raft-enabled yes
raft.log-filename "raft.log"
raft.node-id "node-1"
raft.cluster-nodes "node-1:6379,node-2:6379,node-3:6379"
raft.election-timeout 1000
raft.heartbeat-interval 100
```

### 3.2 Raft集群部署

**Raft集群部署**：

```bash
# 启动Raft节点1
redis-server --port 6379 --raft-enabled yes --raft.node-id node-1

# 启动Raft节点2
redis-server --port 6380 --raft-enabled yes --raft.node-id node-2

# 启动Raft节点3
redis-server --port 6381 --raft-enabled yes --raft.node-id node-3
```

---

## 4. Raft实践案例

### 4.1 主节点选举

**主节点选举流程**：

1. Follower超时未收到Leader心跳
2. 转换为Candidate，发起选举
3. 获得多数票后成为Leader

**选举代码示例**：

```python
def request_vote(self, candidate_term, candidate_id):
    if candidate_term > self.current_term:
        self.current_term = candidate_term
        self.voted_for = candidate_id
        return True
    return False
```

### 4.2 日志复制

**日志复制流程**：

1. Leader接收客户端请求
2. 追加到本地日志
3. 复制到所有Follower
4. 多数确认后提交

**日志复制代码示例**：

```python
def append_entries(self, term, leader_id, prev_log_index, entries):
    if term >= self.current_term:
        self.current_term = term
        self.leader_id = leader_id
        # 追加日志条目
        self.log.extend(entries)
        return True
    return False
```

---

## 5. 扩展阅读

- [Paxos协议实践](08.01.02-Paxos协议实践.md)
- [Redis Cluster集群模式](../../03-Redis组件/03.03-高可用架构/03.03.03-Cluster集群模式.md)
- [集群部署实践](../../07-运维与部署/07.05-集群管理/07.05.01-集群部署实践.md)

---

## 6. 权威参考

### 6.1 官方文档

- [Raft论文](https://raft.github.io/)
- [Redis Raft模块](https://redis.io/docs/manual/patterns/distributed-locks/)

### 6.2 经典书籍

- **《分布式系统概念与设计》** - 作者：George Coulouris，ISBN：9787111544937

---

**文档版本**：v1.0
**最后更新**：2025-01
**文档状态**：✅ 完成
