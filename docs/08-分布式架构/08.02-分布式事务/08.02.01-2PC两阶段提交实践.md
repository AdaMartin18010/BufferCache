# 08.02.01 2PC两阶段提交实践

## 目录

- [08.02.01 2PC两阶段提交实践](#080201-2pc两阶段提交实践)
  - [目录](#目录)
  - [1. 概述](#1-概述)
    - [1.1 定义与背景](#11-定义与背景)
    - [1.2 应用价值](#12-应用价值)
  - [2. 2PC协议基础](#2-2pc协议基础)
    - [2.1 2PC流程](#21-2pc流程)
    - [2.2 2PC状态机](#22-2pc状态机)
  - [3. Redis 2PC实现](#3-redis-2pc实现)
    - [3.1 2PC实现代码](#31-2pc实现代码)
    - [3.2 故障处理](#32-故障处理)
  - [4. 实践案例](#4-实践案例)
    - [4.1 跨Redis事务](#41-跨redis事务)
    - [4.2 Redis+MySQL事务](#42-redismysql事务)
  - [5. 扩展阅读](#5-扩展阅读)
  - [6. 权威参考](#6-权威参考)
    - [6.1 官方文档](#61-官方文档)
    - [6.2 经典书籍](#62-经典书籍)

---

## 1. 概述

### 1.1 定义与背景

**2PC（Two-Phase Commit）**是一种分布式事务协议，用于保证分布式事务的一致性。

**2PC特点**：

- ✅ **强一致性**：保证强一致性
- ⚠️ **阻塞性**：存在阻塞问题
- ⚠️ **单点故障**：协调者单点故障

### 1.2 应用价值

2PC在分布式系统中的应用价值：

1. **强一致性**：保证分布式事务强一致性
2. **简单实现**：实现相对简单
3. **广泛应用**：数据库XA事务使用

---

## 2. 2PC协议基础

### 2.1 2PC流程

**2PC两阶段**：

1. **Prepare阶段**：协调者发送Prepare请求，参与者准备提交
2. **Commit阶段**：协调者发送Commit请求，参与者提交

**2PC流程图**：

```text
协调者                   参与者1              参与者2
  |                        |                   |
  |---Prepare------------->|                   |
  |                        |---Prepare-------->|
  |<--Ready----------------|                   |
  |                        |<--Ready-----------|
  |---Commit-------------->|                   |
  |                        |---Commit---------->|
  |<--ACK------------------|                   |
  |                        |<--ACK-------------|
```

### 2.2 2PC状态机

**2PC状态机**：

```python
class TwoPhaseCommit:
    def __init__(self):
        self.state = "INIT"  # INIT, PREPARE, COMMIT, ABORT
        self.participants = []

    def prepare(self):
        self.state = "PREPARE"
        results = []
        for participant in self.participants:
            result = participant.prepare()
            results.append(result)

        if all(results):
            self.state = "COMMIT"
            return True
        else:
            self.state = "ABORT"
            return False

    def commit(self):
        if self.state == "COMMIT":
            for participant in self.participants:
                participant.commit()
```

---

## 3. Redis 2PC实现

### 3.1 2PC实现代码

**Redis 2PC实现**：

```python
import redis

class Redis2PC:
    def __init__(self, redis_clients):
        self.redis_clients = redis_clients
        self.transaction_id = None

    def prepare(self, transaction_id, operations):
        self.transaction_id = transaction_id
        prepared = []

        for i, (client, op) in enumerate(zip(self.redis_clients, operations)):
            # 执行操作但不提交
            result = client.execute(op, prepare=True)
            prepared.append((i, result))

        return prepared

    def commit(self, prepared):
        for i, result in prepared:
            self.redis_clients[i].commit(result)

    def abort(self, prepared):
        for i, result in prepared:
            self.redis_clients[i].rollback(result)
```

### 3.2 故障处理

**故障处理策略**：

1. **Prepare阶段失败**：回滚所有操作
2. **Commit阶段失败**：重试Commit
3. **超时处理**：超时后回滚

---

## 4. 实践案例

### 4.1 跨Redis事务

**跨Redis事务示例**：

```python
# 跨Redis集群事务
coordinator = Redis2PC([redis1, redis2, redis3])

# Prepare阶段
operations = [
    ("SET", "key1", "value1"),
    ("SET", "key2", "value2"),
    ("SET", "key3", "value3")
]
prepared = coordinator.prepare("tx-001", operations)

# Commit阶段
if prepared:
    coordinator.commit(prepared)
else:
    coordinator.abort(prepared)
```

### 4.2 Redis+MySQL事务

**Redis+MySQL事务示例**：

```python
# Redis和MySQL混合事务
coordinator = TwoPhaseCommit([redis_client, mysql_client])

# Prepare阶段
redis_result = redis_client.prepare("SET", "key", "value")
mysql_result = mysql_client.prepare("UPDATE account SET balance = balance - 100")

# Commit阶段
if redis_result and mysql_result:
    coordinator.commit([redis_result, mysql_result])
```

---

## 5. 扩展阅读

- [TCC补偿事务实践](08.02.02-TCC补偿事务实践.md)
- [Saga长事务实践](08.02.03-Saga长事务实践.md)
- [Write-Through透写缓存](../../04-架构设计/04.01-缓存架构模式/04.01.03-Write-Through透写缓存.md)

---

## 6. 权威参考

### 6.1 官方文档

- [XA事务规范](https://pubs.opengroup.org/onlinepubs/009680699/toc.pdf)
- [Redis事务](https://redis.io/docs/manual/transactions/)

### 6.2 经典书籍

- **《分布式系统概念与设计》** - 作者：George Coulouris，ISBN：9787111544937

---

**文档版本**：v1.0
**最后更新**：2025-01
**文档状态**：✅ 完成
