# 08.02.02 TCC补偿事务实践

## 目录

- [08.02.02 TCC补偿事务实践](#080202-tcc补偿事务实践)
  - [目录](#目录)
  - [1. 概述](#1-概述)
    - [1.1 定义与背景](#11-定义与背景)
    - [1.2 应用价值](#12-应用价值)
  - [2. TCC模式基础](#2-tcc模式基础)
    - [2.1 TCC三阶段](#21-tcc三阶段)
    - [2.2 TCC实现](#22-tcc实现)
  - [3. Redis TCC实践](#3-redis-tcc实践)
    - [3.1 TCC实现代码](#31-tcc实现代码)
    - [3.2 补偿机制](#32-补偿机制)
  - [4. 实践案例](#4-实践案例)
    - [4.1 订单支付场景](#41-订单支付场景)
    - [4.2 库存扣减场景](#42-库存扣减场景)
  - [5. 扩展阅读](#5-扩展阅读)
  - [6. 权威参考](#6-权威参考)
    - [6.1 官方文档](#61-官方文档)
    - [6.2 经典书籍](#62-经典书籍)

---

## 1. 概述

### 1.1 定义与背景

**TCC（Try-Confirm-Cancel）**是一种分布式事务模式，通过业务层面的补偿机制保证事务一致性。

**TCC特点**：

- ✅ **高性能**：无锁设计，性能高
- ✅ **灵活性强**：业务可定制
- ⚠️ **实现复杂**：需要实现Try、Confirm、Cancel三个方法

### 1.2 应用价值

TCC在分布式系统中的应用价值：

1. **高性能**：无锁设计，性能高
2. **灵活性强**：业务可定制
3. **最终一致性**：保证最终一致性

---

## 2. TCC模式基础

### 2.1 TCC三阶段

**TCC三阶段**：

1. **Try阶段**：尝试执行，预留资源
2. **Confirm阶段**：确认提交，释放资源
3. **Cancel阶段**：取消操作，回滚资源

**TCC流程图**：

```text
Try阶段：
  订单服务: Try(冻结库存)
  支付服务: Try(冻结余额)

Confirm阶段：
  订单服务: Confirm(扣减库存)
  支付服务: Confirm(扣减余额)

Cancel阶段（失败时）：
  订单服务: Cancel(释放库存)
  支付服务: Cancel(释放余额)
```

### 2.2 TCC实现

**TCC接口定义**：

```python
class TCCService:
    def try(self, params):
        """尝试执行，预留资源"""
        raise NotImplementedError

    def confirm(self, params):
        """确认提交"""
        raise NotImplementedError

    def cancel(self, params):
        """取消操作"""
        raise NotImplementedError
```

---

## 3. Redis TCC实践

### 3.1 TCC实现代码

**Redis TCC实现**：

```python
import redis

class RedisTCCService:
    def __init__(self, redis_client):
        self.redis = redis_client

    def try(self, key, amount):
        """Try阶段：冻结资源"""
        # 检查余额
        balance = int(self.redis.get(f"balance:{key}") or 0)
        if balance < amount:
            return False

        # 冻结资源
        self.redis.incrby(f"frozen:{key}", amount)
        self.redis.decrby(f"balance:{key}", amount)
        return True

    def confirm(self, key, amount):
        """Confirm阶段：确认扣减"""
        # 释放冻结资源
        self.redis.decrby(f"frozen:{key}", amount)
        return True

    def cancel(self, key, amount):
        """Cancel阶段：回滚"""
        # 恢复余额
        self.redis.incrby(f"balance:{key}", amount)
        self.redis.decrby(f"frozen:{key}", amount)
        return True
```

### 3.2 补偿机制

**补偿机制**：

```python
class TCCCoordinator:
    def __init__(self):
        self.services = []
        self.tried = []

    def execute(self, operations):
        # Try阶段
        for service, params in operations:
            if not service.try(**params):
                # Try失败，执行Cancel
                self.cancel_all()
                return False
            self.tried.append((service, params))

        # Confirm阶段
        for service, params in self.tried:
            service.confirm(**params)

        return True

    def cancel_all(self):
        # Cancel所有已Try的操作
        for service, params in reversed(self.tried):
            service.cancel(**params)
```

---

## 4. 实践案例

### 4.1 订单支付场景

**订单支付TCC实现**：

```python
# 订单服务
class OrderService(RedisTCCService):
    def try(self, order_id, amount):
        # 冻结库存
        return super().try(f"order:{order_id}", amount)

    def confirm(self, order_id, amount):
        # 确认扣减库存
        return super().confirm(f"order:{order_id}", amount)

    def cancel(self, order_id, amount):
        # 释放库存
        return super().cancel(f"order:{order_id}", amount)

# 支付服务
class PaymentService(RedisTCCService):
    def try(self, user_id, amount):
        # 冻结余额
        return super().try(f"user:{user_id}", amount)

# TCC协调
coordinator = TCCCoordinator()
coordinator.execute([
    (OrderService(redis), {"order_id": "001", "amount": 100}),
    (PaymentService(redis), {"user_id": "123", "amount": 100})
])
```

### 4.2 库存扣减场景

**库存扣减TCC实现**：

```python
class InventoryService(RedisTCCService):
    def try(self, product_id, quantity):
        # 冻结库存
        stock = int(self.redis.get(f"stock:{product_id}") or 0)
        if stock < quantity:
            return False

        self.redis.incrby(f"frozen_stock:{product_id}", quantity)
        self.redis.decrby(f"stock:{product_id}", quantity)
        return True
```

---

## 5. 扩展阅读

- [2PC两阶段提交实践](08.02.01-2PC两阶段提交实践.md)
- [Saga长事务实践](08.02.03-Saga长事务实践.md)

---

## 6. 权威参考

### 6.1 官方文档

- [TCC模式论文](https://www.infoq.cn/article/saga-pattern-microservices/)

### 6.2 经典书籍

- **《微服务架构设计模式》** - 作者：Chris Richardson，ISBN：9787111631087

---

**文档版本**：v1.0
**最后更新**：2025-01
**文档状态**：✅ 完成
