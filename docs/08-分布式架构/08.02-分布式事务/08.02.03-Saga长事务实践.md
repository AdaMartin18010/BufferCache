# 08.02.03 Saga长事务实践

## 目录

- [08.02.03 Saga长事务实践](#080203-saga长事务实践)
  - [目录](#目录)
  - [1. 概述](#1-概述)
    - [1.1 定义与背景](#11-定义与背景)
    - [1.2 应用价值](#12-应用价值)
  - [2. Saga模式基础](#2-saga模式基础)
    - [2.1 Saga两种模式](#21-saga两种模式)
    - [2.2 Saga实现](#22-saga实现)
  - [3. Redis Saga实践](#3-redis-saga实践)
    - [3.1 Saga实现代码](#31-saga实现代码)
    - [3.2 补偿机制](#32-补偿机制)
  - [4. 实践案例](#4-实践案例)
    - [4.1 订单流程场景](#41-订单流程场景)
    - [4.2 分布式工作流](#42-分布式工作流)
  - [5. 扩展阅读](#5-扩展阅读)
  - [6. 权威参考](#6-权威参考)
    - [6.1 官方文档](#61-官方文档)
    - [6.2 经典书籍](#62-经典书籍)

---

## 1. 概述

### 1.1 定义与背景

**Saga**是一种长事务模式，通过一系列本地事务和补偿操作实现分布式事务。

**Saga特点**：

- ✅ **长事务支持**：支持长时间运行的事务
- ✅ **最终一致性**：保证最终一致性
- ⚠️ **补偿复杂**：需要实现补偿逻辑

### 1.2 应用价值

Saga在分布式系统中的应用价值：

1. **长事务支持**：支持长时间运行的事务
2. **最终一致性**：保证最终一致性
3. **性能优化**：避免长时间锁定资源

---

## 2. Saga模式基础

### 2.1 Saga两种模式

**Saga两种模式**：

1. **Choreography（编排）**：每个服务发布事件，其他服务订阅
2. **Orchestration（协调）**：协调者统一调度

**Saga流程图（编排模式）**：

```text
订单服务 → 发布订单创建事件
  ↓
库存服务 → 订阅事件 → 扣减库存 → 发布库存扣减事件
  ↓
支付服务 → 订阅事件 → 扣减余额 → 发布支付成功事件
  ↓
订单服务 → 订阅事件 → 更新订单状态
```

### 2.2 Saga实现

**Saga接口定义**：

```python
class SagaStep:
    def execute(self, params):
        """执行步骤"""
        raise NotImplementedError

    def compensate(self, params):
        """补偿步骤"""
        raise NotImplementedError
```

---

## 3. Redis Saga实践

### 3.1 Saga实现代码

**Redis Saga实现**：

```python
import redis
import json

class RedisSaga:
    def __init__(self, redis_client):
        self.redis = redis_client
        self.steps = []
        self.executed_steps = []

    def add_step(self, step):
        self.steps.append(step)

    def execute(self):
        """执行Saga事务"""
        for step in self.steps:
            try:
                result = step.execute()
                self.executed_steps.append((step, result))
            except Exception as e:
                # 执行失败，补偿已执行的步骤
                self.compensate_all()
                raise e

    def compensate_all(self):
        """补偿所有已执行的步骤"""
        for step, result in reversed(self.executed_steps):
            step.compensate(result)
```

### 3.2 补偿机制

**补偿机制实现**：

```python
class OrderSagaStep:
    def __init__(self, redis_client):
        self.redis = redis_client

    def execute(self, order_id, amount):
        # 创建订单
        self.redis.set(f"order:{order_id}", json.dumps({
            "status": "created",
            "amount": amount
        }))
        return {"order_id": order_id}

    def compensate(self, result):
        # 删除订单
        order_id = result["order_id"]
        self.redis.delete(f"order:{order_id}")

class InventorySagaStep:
    def __init__(self, redis_client):
        self.redis = redis_client

    def execute(self, product_id, quantity):
        # 扣减库存
        stock = int(self.redis.get(f"stock:{product_id}") or 0)
        if stock < quantity:
            raise Exception("库存不足")

        self.redis.decrby(f"stock:{product_id}", quantity)
        return {"product_id": product_id, "quantity": quantity}

    def compensate(self, result):
        # 恢复库存
        product_id = result["product_id"]
        quantity = result["quantity"]
        self.redis.incrby(f"stock:{product_id}", quantity)
```

---

## 4. 实践案例

### 4.1 订单流程场景

**订单流程Saga实现**：

```python
# 创建Saga事务
saga = RedisSaga(redis_client)

# 添加步骤
saga.add_step(OrderSagaStep(redis_client))
saga.add_step(InventorySagaStep(redis_client))
saga.add_step(PaymentSagaStep(redis_client))

# 执行Saga
try:
    saga.execute()
    print("订单创建成功")
except Exception as e:
    print(f"订单创建失败: {e}")
    # 补偿已自动执行
```

### 4.2 分布式工作流

**分布式工作流Saga实现**：

```python
class WorkflowSaga:
    def __init__(self):
        self.workflow = []

    def add_workflow_step(self, service, operation, compensation):
        self.workflow.append({
            "service": service,
            "operation": operation,
            "compensation": compensation
        })

    def execute_workflow(self):
        executed = []
        for step in self.workflow:
            try:
                result = step["service"].execute(step["operation"])
                executed.append((step, result))
            except Exception:
                # 补偿已执行的步骤
                for s, r in reversed(executed):
                    s["service"].execute(s["compensation"], r)
                raise
```

---

## 5. 扩展阅读

- [2PC两阶段提交实践](08.02.01-2PC两阶段提交实践.md)
- [TCC补偿事务实践](08.02.02-TCC补偿事务实践.md)

---

## 6. 权威参考

### 6.1 官方文档

- [Saga模式论文](https://www.infoq.cn/article/saga-pattern-microservices/)

### 6.2 经典书籍

- **《微服务架构设计模式》** - 作者：Chris Richardson，ISBN：9787111631087

---

**文档版本**：v1.0
**最后更新**：2025-01
**文档状态**：✅ 完成
