# 08.03.02 分布式协调服务实践

## 目录

- [08.03.02 分布式协调服务实践](#080302-分布式协调服务实践)
  - [目录](#目录)
  - [1. 概述](#1-概述)
  - [2. ZooKeeper实践](#2-zookeeper实践)
    - [2.1 ZooKeeper部署](#21-zookeeper部署)
    - [2.2 Redis服务注册](#22-redis服务注册)
  - [3. etcd实践](#3-etcd实践)
    - [3.1 etcd部署](#31-etcd部署)
    - [3.2 Redis服务注册（etcd）](#32-redis服务注册etcd)
  - [4. Consul实践](#4-consul实践)
    - [4.1 Consul部署](#41-consul部署)
    - [4.2 Redis服务注册（Consul）](#42-redis服务注册consul)
  - [5. Redis作为协调服务](#5-redis作为协调服务)
    - [5.1 Redis Pub/Sub实现服务发现](#51-redis-pubsub实现服务发现)
  - [6. 最佳实践](#6-最佳实践)
    - [6.1 服务注册](#61-服务注册)
    - [6.2 服务发现](#62-服务发现)
    - [6.3 配置管理](#63-配置管理)
  - [7. 扩展阅读](#7-扩展阅读)

---

## 1. 概述

分布式协调服务用于在分布式系统中实现服务发现、配置管理、分布式锁等功能。

**核心功能**：

- 服务发现
- 配置管理
- 分布式锁
- 选主（Leader Election）
- 分布式队列

---

## 2. ZooKeeper实践

### 2.1 ZooKeeper部署

**ZooKeeper集群部署**：

```yaml
# docker-compose.yml
version: '3.8'
services:
  zookeeper1:
    image: zookeeper:3.9
    ports:
      - "2181:2181"
    environment:
      ZOO_MY_ID: 1
      ZOO_SERVERS: server.1=zookeeper1:2888:3888;2181 server.2=zookeeper2:2888:3888;2181 server.3=zookeeper3:2888:3888;2181
    volumes:
      - zk1_data:/data
      - zk1_log:/datalog

  zookeeper2:
    image: zookeeper:3.9
    ports:
      - "2182:2181"
    environment:
      ZOO_MY_ID: 2
      ZOO_SERVERS: server.1=zookeeper1:2888:3888;2181 server.2=zookeeper2:2888:3888;2181 server.3=zookeeper3:2888:3888;2181
    volumes:
      - zk2_data:/data
      - zk2_log:/datalog

  zookeeper3:
    image: zookeeper:3.9
    ports:
      - "2183:2181"
    environment:
      ZOO_MY_ID: 3
      ZOO_SERVERS: server.1=zookeeper1:2888:3888;2181 server.2=zookeeper2:2888:3888;2181 server.3=zookeeper3:2888:3888;2181
    volumes:
      - zk3_data:/data
      - zk3_log:/datalog

volumes:
  zk1_data:
  zk1_log:
  zk2_data:
  zk2_log:
  zk3_data:
  zk3_log:
```

### 2.2 Redis服务注册

**使用ZooKeeper进行服务注册**：

```python
from kazoo.client import KazooClient
import json

class ServiceRegistry:
    def __init__(self, zk_hosts='localhost:2181'):
        self.zk = KazooClient(hosts=zk_hosts)
        self.zk.start()
        self.base_path = '/redis/services'

    def register(self, service_name, host, port):
        """注册服务"""
        service_path = f"{self.base_path}/{service_name}"
        self.zk.ensure_path(service_path)

        node_path = f"{service_path}/{host}:{port}"
        service_data = json.dumps({
            'host': host,
            'port': port,
            'timestamp': time.time()
        })

        self.zk.create(node_path, service_data.encode(), ephemeral=True)

    def discover(self, service_name):
        """发现服务"""
        service_path = f"{self.base_path}/{service_name}"
        if not self.zk.exists(service_path):
            return []

        nodes = self.zk.get_children(service_path)
        services = []

        for node in nodes:
            node_path = f"{service_path}/{node}"
            data, _ = self.zk.get(node_path)
            service_info = json.loads(data.decode())
            services.append(service_info)

        return services
```

---

## 3. etcd实践

### 3.1 etcd部署

**etcd集群部署**：

```yaml
# docker-compose.yml
version: '3.8'
services:
  etcd1:
    image: quay.io/coreos/etcd:v3.5.0
    command:
      - /usr/local/bin/etcd
      - --name=etcd1
      - --data-dir=/etcd-data
      - --listen-client-urls=http://0.0.0.0:2379
      - --advertise-client-urls=http://etcd1:2379
      - --listen-peer-urls=http://0.0.0.0:2380
      - --initial-advertise-peer-urls=http://etcd1:2380
      - --initial-cluster=etcd1=http://etcd1:2380,etcd2=http://etcd2:2380,etcd3=http://etcd3:2380
      - --initial-cluster-token=etcd-cluster-1
      - --initial-cluster-state=new
    ports:
      - "2379:2379"
      - "2380:2380"
    volumes:
      - etcd1_data:/etcd-data

volumes:
  etcd1_data:
```

### 3.2 Redis服务注册（etcd）

```python
import etcd3
import json
import time

class EtcdServiceRegistry:
    def __init__(self, etcd_host='localhost', etcd_port=2379):
        self.client = etcd3.client(host=etcd_host, port=etcd_port)
        self.base_key = '/redis/services'

    def register(self, service_name, host, port, ttl=30):
        """注册服务"""
        key = f"{self.base_key}/{service_name}/{host}:{port}"
        value = json.dumps({
            'host': host,
            'port': port,
            'timestamp': time.time()
        })

        # 创建租约并定期续期
        lease = self.client.lease(ttl)
        self.client.put(key, value, lease=lease)

        # 定期续期
        def renew():
            while True:
                time.sleep(ttl // 3)
                lease.refresh()

        import threading
        threading.Thread(target=renew, daemon=True).start()

    def discover(self, service_name):
        """发现服务"""
        prefix = f"{self.base_key}/{service_name}/"
        services = []

        for value, metadata in self.client.get_prefix(prefix):
            service_info = json.loads(value.decode())
            services.append(service_info)

        return services
```

---

## 4. Consul实践

### 4.1 Consul部署

```yaml
# docker-compose.yml
version: '3.8'
services:
  consul:
    image: consul:1.16
    ports:
      - "8500:8500"
    command: consul agent -dev -client=0.0.0.0
```

### 4.2 Redis服务注册（Consul）

```python
import consul
import time

class ConsulServiceRegistry:
    def __init__(self, consul_host='localhost', consul_port=8500):
        self.client = consul.Consul(host=consul_host, port=consul_port)

    def register(self, service_name, host, port):
        """注册服务"""
        self.client.agent.service.register(
            name=service_name,
            service_id=f"{service_name}-{host}-{port}",
            address=host,
            port=port,
            check=consul.Check.tcp(host, port, interval="10s")
        )

    def discover(self, service_name):
        """发现服务"""
        _, services = self.client.health.service(service_name, passing=True)
        return [
            {
                'host': service['Service']['Address'],
                'port': service['Service']['Port']
            }
            for service in services
        ]
```

---

## 5. Redis作为协调服务

### 5.1 Redis Pub/Sub实现服务发现

```python
import redis
import json
import threading

class RedisServiceRegistry:
    def __init__(self, redis_host='localhost', redis_port=6379):
        self.redis_client = redis.Redis(host=redis_host, port=redis_port)
        self.pubsub = self.redis_client.pubsub()
        self.services = {}

    def register(self, service_name, host, port):
        """注册服务"""
        service_key = f"service:{service_name}"
        service_info = {
            'host': host,
            'port': port,
            'timestamp': time.time()
        }

        # 存储服务信息
        self.redis_client.hset(
            service_key,
            f"{host}:{port}",
            json.dumps(service_info)
        )

        # 设置过期时间
        self.redis_client.expire(service_key, 60)

        # 发布服务注册事件
        self.redis_client.publish(
            f"service:register:{service_name}",
            json.dumps(service_info)
        )

        # 定期续期
        def renew():
            while True:
                time.sleep(20)
                self.redis_client.hset(
                    service_key,
                    f"{host}:{port}",
                    json.dumps(service_info)
                )
                self.redis_client.expire(service_key, 60)

        threading.Thread(target=renew, daemon=True).start()

    def discover(self, service_name):
        """发现服务"""
        service_key = f"service:{service_name}"
        services = self.redis_client.hgetall(service_key)

        result = []
        for key, value in services.items():
            service_info = json.loads(value.decode())
            result.append(service_info)

        return result
```

---

## 6. 最佳实践

### 6.1 服务注册

- ✅ 使用临时节点（ephemeral）或租约（lease）
- ✅ 定期续期保持服务在线
- ✅ 服务下线时自动注销

### 6.2 服务发现

- ✅ 监听服务变化事件
- ✅ 缓存服务列表
- ✅ 实现负载均衡

### 6.3 配置管理

- ✅ 使用配置中心统一管理
- ✅ 支持配置变更通知
- ✅ 配置版本管理

---

## 7. 扩展阅读

- [ZooKeeper官方文档](https://zookeeper.apache.org/)
- [etcd官方文档](https://etcd.io/docs/)
- [Consul官方文档](https://www.consul.io/docs)
