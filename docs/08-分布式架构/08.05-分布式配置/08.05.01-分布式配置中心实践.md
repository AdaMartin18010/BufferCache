# 08.05.01 分布式配置中心实践

## 目录

- [08.05.01 分布式配置中心实践](#080501-分布式配置中心实践)
  - [目录](#目录)
  - [1. 概述](#1-概述)
  - [2. 配置中心架构](#2-配置中心架构)
    - [2.1 架构设计](#21-架构设计)
    - [2.2 Redis配置存储](#22-redis配置存储)
  - [3. Redis配置中心实现](#3-redis配置中心实现)
    - [3.1 配置管理](#31-配置管理)
    - [3.2 配置分组](#32-配置分组)
  - [4. 配置变更通知](#4-配置变更通知)
    - [4.1 Pub/Sub通知](#41-pubsub通知)
    - [4.2 Webhook通知](#42-webhook通知)
  - [5. 配置版本管理](#5-配置版本管理)
    - [5.1 版本控制](#51-版本控制)
  - [6. 最佳实践](#6-最佳实践)
    - [6.1 配置管理](#61-配置管理)
    - [6.2 配置更新](#62-配置更新)
    - [6.3 配置安全](#63-配置安全)
  - [7. 扩展阅读](#7-扩展阅读)

---

## 1. 概述

分布式配置中心用于集中管理分布式系统的配置，支持配置的动态更新和版本管理。

**核心功能**：

- 配置集中管理
- 配置动态更新
- 配置版本管理
- 配置变更通知

---

## 2. 配置中心架构

### 2.1 架构设计

```text
配置中心 ──> Redis存储
         ──> 配置变更通知（Pub/Sub）
         ──> 配置版本管理
```

### 2.2 Redis配置存储

```python
import redis
import json

class RedisConfigCenter:
    def __init__(self, redis_client):
        self.redis_client = redis_client
        self.config_prefix = 'config:'
        self.version_prefix = 'config:version:'

    def set_config(self, key, value, version=1):
        """设置配置"""
        config_key = f"{self.config_prefix}{key}"
        version_key = f"{self.version_prefix}{key}"

        config_data = {
            'value': value,
            'version': version,
            'timestamp': time.time()
        }

        self.redis_client.set(config_key, json.dumps(config_data))
        self.redis_client.set(version_key, version)

        # 发布配置变更通知
        self.redis_client.publish(f"config:change:{key}", json.dumps(config_data))

    def get_config(self, key, default=None):
        """获取配置"""
        config_key = f"{self.config_prefix}{key}"
        config_data = self.redis_client.get(config_key)

        if config_data:
            return json.loads(config_data)['value']
        return default

    def get_config_with_version(self, key):
        """获取配置和版本"""
        config_key = f"{self.config_prefix}{key}"
        config_data = self.redis_client.get(config_key)

        if config_data:
            return json.loads(config_data)
        return None
```

---

## 3. Redis配置中心实现

### 3.1 配置管理

```python
class ConfigManager:
    def __init__(self, redis_client):
        self.config_center = RedisConfigCenter(redis_client)
        self.configs = {}
        self.listeners = {}

    def load_config(self, key, default=None):
        """加载配置"""
        config = self.config_center.get_config(key, default)
        self.configs[key] = config
        return config

    def watch_config(self, key, callback):
        """监听配置变更"""
        if key not in self.listeners:
            self.listeners[key] = []
        self.listeners[key].append(callback)

        # 订阅配置变更
        pubsub = self.config_center.redis_client.pubsub()
        pubsub.subscribe(f"config:change:{key}")

        def listen():
            for message in pubsub.listen():
                if message['type'] == 'message':
                    config_data = json.loads(message['data'])
                    self.configs[key] = config_data['value']
                    for callback in self.listeners[key]:
                        callback(config_data['value'])

        import threading
        threading.Thread(target=listen, daemon=True).start()
```

### 3.2 配置分组

```python
class GroupedConfigCenter:
    def __init__(self, redis_client):
        self.redis_client = redis_client
        self.group_prefix = 'config:group:'

    def set_group_config(self, group, key, value):
        """设置分组配置"""
        group_key = f"{self.group_prefix}{group}:{key}"
        self.redis_client.set(group_key, json.dumps(value))

        # 发布分组配置变更
        self.redis_client.publish(
            f"config:group:change:{group}",
            json.dumps({'key': key, 'value': value})
        )

    def get_group_configs(self, group):
        """获取分组所有配置"""
        pattern = f"{self.group_prefix}{group}:*"
        keys = self.redis_client.keys(pattern)

        configs = {}
        for key in keys:
            config_key = key.decode().replace(f"{self.group_prefix}{group}:", '')
            config_value = json.loads(self.redis_client.get(key))
            configs[config_key] = config_value

        return configs
```

---

## 4. 配置变更通知

### 4.1 Pub/Sub通知

```python
class ConfigNotifier:
    def __init__(self, redis_client):
        self.redis_client = redis_client
        self.pubsub = redis_client.pubsub()

    def subscribe(self, key, callback):
        """订阅配置变更"""
        channel = f"config:change:{key}"
        self.pubsub.subscribe(channel)

        def listen():
            for message in self.pubsub.listen():
                if message['type'] == 'message':
                    config_data = json.loads(message['data'])
                    callback(config_data)

        import threading
        threading.Thread(target=listen, daemon=True).start()
```

### 4.2 Webhook通知

```python
import requests

class WebhookNotifier:
    def __init__(self, webhook_url):
        self.webhook_url = webhook_url

    def notify(self, key, value):
        """Webhook通知"""
        payload = {
            'key': key,
            'value': value,
            'timestamp': time.time()
        }

        try:
            requests.post(self.webhook_url, json=payload, timeout=5)
        except Exception as e:
            print(f"Webhook通知失败: {e}")
```

---

## 5. 配置版本管理

### 5.1 版本控制

```python
class VersionedConfigCenter:
    def __init__(self, redis_client):
        self.redis_client = redis_client
        self.config_prefix = 'config:'
        self.version_prefix = 'config:version:'
        self.history_prefix = 'config:history:'

    def set_config(self, key, value):
        """设置配置（自动版本管理）"""
        version_key = f"{self.version_prefix}{key}"
        current_version = self.redis_client.get(version_key)

        if current_version:
            version = int(current_version) + 1
        else:
            version = 1

        # 保存历史版本
        history_key = f"{self.history_prefix}{key}:{version}"
        history_data = {
            'value': value,
            'version': version,
            'timestamp': time.time()
        }
        self.redis_client.set(history_key, json.dumps(history_data))

        # 更新当前配置
        config_key = f"{self.config_prefix}{key}"
        self.redis_client.set(config_key, json.dumps(history_data))
        self.redis_client.set(version_key, version)

    def get_config_version(self, key, version):
        """获取指定版本的配置"""
        history_key = f"{self.history_prefix}{key}:{version}"
        history_data = self.redis_client.get(history_key)

        if history_data:
            return json.loads(history_data)
        return None

    def rollback_config(self, key, version):
        """回滚配置"""
        history_data = self.get_config_version(key, version)
        if history_data:
            self.set_config(key, history_data['value'])
            return True
        return False
```

---

## 6. 最佳实践

### 6.1 配置管理

- ✅ 配置集中管理
- ✅ 支持配置分组
- ✅ 配置版本管理

### 6.2 配置更新

- ✅ 支持动态更新
- ✅ 配置变更通知
- ✅ 配置回滚机制

### 6.3 配置安全

- ✅ 配置加密存储
- ✅ 配置访问控制
- ✅ 配置审计日志

---

## 7. 扩展阅读

- [Apollo配置中心](https://github.com/apolloconfig/apollo)
- [Nacos配置中心](https://nacos.io/)
- [Spring Cloud Config](https://spring.io/projects/spring-cloud-config)
